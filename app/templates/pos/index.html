{% extends "base.html" %}

{% block title %}POS - Restaurant POS{% endblock %}

{% block content %}
<!-- Dark Theme POS Styles - Performance Optimized -->
<style id="initial-pos-prefs">
  :root{
    --pos-card-width: {{ ui_prefs.card_width_pct }}%;
    --pos-card-min-height: {{ ui_prefs.card_min_height_px }}px;
    --pos-font-size: {{ ui_prefs.font_size_px }}px;
    --pos-price-scale: {{ ui_prefs.price_badge_scale }};
    --name-badge-size: {{ ui_prefs.name_badge_scale * 14 }}px;
    --special-width-pct: {{ ui_prefs.special_width_pct }};
    --special-height-px: {{ ui_prefs.special_height_px }};
    --special-font-px: {{ ui_prefs.special_font_px }};
    --special-spacing-px: {{ ui_prefs.special_spacing_px }};
    --special-sidebar-width: {{ ui_prefs.special_sidebar_width }};
  }
  
  /* Apply initial sizing immediately - NO ANIMATIONS for performance */
  .pos-item-col.dyn-width { 
    flex: 0 0 {{ ui_prefs.card_width_pct }}% !important; 
    max-width: {{ ui_prefs.card_width_pct }}% !important;
  }
  .modern-item.dyn-height { 
    min-height: {{ ui_prefs.card_min_height_px }}px !important;
  }
  .modern-item.dyn-height .item-thumb { 
    height: {{ ui_prefs.card_min_height_px * 0.56 }}px !important;
  }
  /* Dark theme overrides for POS items */
  .modern-item {
    background-color: var(--card-bg) !important;
    border: 1px solid var(--card-border) !important;
    color: var(--text-primary) !important;
  }
  
  /* TRANSPARENT name badges for regular and special items */
  .transparent-name-badge {
    font-size: {{ ui_prefs.name_badge_scale * ui_prefs.font_size_px }}px !important;
    background-color: transparent !important;
    background: transparent !important;
    color: #ffffff !important;
    border: none !important;
    box-shadow: none !important;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8) !important;
    font-weight: 600 !important;
  }
  {% if not ui_prefs.show_images %}
  .modern-item .item-thumb { display: none !important; }
  .modern-item .item-body { display: flex !important; align-items: center !important; justify-content: center !important; text-align: center !important; }
  .modern-item .item-content { width: 100% !important; display: flex !important; flex-direction: column !important; align-items: center !important; justify-content: center !important; height: 100% !important; }
  {% endif %}
</style>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    try{
      var SHOW_IMAGES = {% if ui_prefs.show_images %}true{% else %}false{% endif %};
      if (!SHOW_IMAGES) { document.body.classList.add('no-images'); }
    }catch(e){}
  });
</script>

<div class="row g-3">
    <!-- Combined Menu Items and Special Items Column -->
    <div class="col-xl-8 col-lg-9 col-md-8">
        <div class="card">
            <div class="card-body">
                <!-- Advanced Toolbar: Lock/Unlock and Tiny Customize Icon -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <button id="editLockBtn" class="btn btn-sm btn-outline-warning" title="Toggle Edit Mode - Lock/Unlock item customization">
                            <i class="bi bi-lock-fill" id="editLockIcon"></i>
                            <span class="d-none d-md-inline">Lock</span>
                        </button>
                        <div id="editModeIndicator" class="badge bg-danger d-none">
                            <i class="bi bi-unlock"></i> EDIT MODE - Double-tap items to change colors, drag to reorder
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <button id="customizeSizeBtn" class="btn btn-sm p-1" style="width: 28px; height: 28px; font-size: 12px;" title="Customize view">
                            <i class="bi bi-sliders"></i>
                        </button>
                        {% if special_items %}
                        <button id="customizeSpecialBtn" class="btn btn-sm p-1" style="width: 28px; height: 28px; font-size: 12px;" title="Customize Special Items">
                            <i class="bi bi-sliders"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Categories and Edit Mode Controls -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="flex-grow-1">
                        <ul class="nav nav-tabs" id="categoryTabs" role="tablist">
                        {% for category in categories %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if loop.first %}active{% endif %}" 
                                    id="cat-{{ category.id }}-tab" 
                                    data-bs-toggle="tab" 
                                    data-bs-target="#cat-{{ category.id }}" 
                                    type="button" 
                                    role="tab">
                                {{ category.name }}
                            </button>
                        </li>
                        {% endfor %}
                        </ul>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-sm btn-outline-secondary" id="editModeBtn" onclick="toggleEditMode()">
                            <i class="bi bi-lock" id="editModeIcon"></i> <span id="editModeText">Edit</span>
                        </button>
                        <button class="btn btn-sm btn-success d-none" id="saveCustomizationsBtn" onclick="saveItemCustomizations()">
                            <i class="bi bi-check-circle"></i> Save
                        </button>
                    </div>
                </div>

                <!-- Combined Menu Items and Special Items Container -->
                <div class="d-flex gap-3">
                    <!-- Menu Items Section -->
                    <div class="flex-grow-1">
                        <div class="tab-content" id="categoryTabsContent">
                            {% for category in categories %}
                            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                                 id="cat-{{ category.id }}" 
                                 role="tabpanel">
                                <div class="row g-2 g-md-3">
                                    {% for item in items if item.category_id == category.id %}
                                    <div class="col-6 col-md-4 col-lg-3 pos-item-col dyn-width">
                                        <div class="card modern-item dyn-height item-card draggable-item" 
                                             data-item-id="{{ item.id }}" 
                                             data-item-name="{{ item.name }}" 
                                             data-item-price="{{ item.price }}"
                                             data-original-category="{{ item.original_category_id or item.category_id }}"
                                             data-custom-color="{{ item_colors.get(item.id, '') }}"
                                             data-item-order="{{ loop.index0 }}"
                                             style="{% if item_colors.get(item.id) %}background-color: {{ item_colors.get(item.id) }} !important; border-color: {{ item_colors.get(item.id) }} !important;{% else %}background-color: var(--default-item-bg-{{ loop.index0 % 8 }});{% endif %} cursor: pointer; transition: all 0.3s ease;"
                                        >
                                            <!-- Customization Icons (only visible in edit mode) -->
                                            <div class="position-absolute top-0 end-0 p-1 edit-mode-controls d-none" style="z-index: 15;">
                                                <button class="btn btn-sm btn-outline-light color-picker-btn" style="width: 24px; height: 24px; padding: 2px;" title="Change Color">
                                                    <i class="bi bi-palette" style="font-size: 10px;"></i>
                                                </button>
                                            </div>
                                            
                                            <!-- Visual Badges -->
                                            <div class="position-absolute top-0 start-0 p-1 d-flex flex-wrap gap-1" style="z-index: 10;">
                                                <!-- Portion Type Badge (Show only if not default) -->
                                                {% if item.portion_type and item.portion_type != 'plate' %}
                                                <span class="badge bg-warning text-dark fw-bold" style="font-size: 0.7rem;">
                                                    {{ item.portion_type|upper }}
                                                </span>
                                                {% elif item.portion_type == 'plate' %}
                                                <span class="badge bg-info text-white fw-bold" style="font-size: 0.7rem;">
                                                    PLATE
                                                </span>
                                                {% endif %}
                                                
                                                <!-- Size Flag Badge (Show only if not default) -->
                                                {% if item.size_flag and item.size_flag != 'medium' %}
                                                <span class="badge bg-secondary text-white fw-bold" style="font-size: 0.7rem;">
                                                    {{ item.size_flag|upper }}
                                                </span>
                                                {% endif %}
                                                
                                                <!-- Priority Badge (Show if not normal) -->
                                                {% if item.visual_priority and item.visual_priority != 'normal' %}
                                                <span class="badge bg-{{ 'success' if item.visual_priority == '+' else 'danger' }} text-white fw-bold" style="font-size: 0.8rem;">
                                                    {{ item.visual_priority }}
                                                </span>
                                                {% endif %}
                                                
                                                <!-- Custom Price Badge for Falafel Hab -->
                                                {% if item.name == 'Falafel Hab' %}
                                                <span class="badge bg-gradient text-white fw-bold falafel-hab-badge" style="font-size: 0.7rem; background: linear-gradient(45deg, #ff6b35, #f7931e) !important;">
                                                    <i class="bi bi-calculator me-1"></i>CUSTOM
                                                </span>
                                                {% endif %}
                                                
                                                <!-- Custom Price Badge for Special Order -->
                                                {% if item.name == 'special order' %}
                                                <span class="badge bg-gradient text-white fw-bold special-order-badge" style="font-size: 0.7rem; background: linear-gradient(45deg, #28a745, #20c997) !important;">
                                                    <i class="bi bi-calculator me-1"></i>CUSTOM
                                                </span>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="item-thumb">
                                                {% if item.image_url %}
                                                <img src="{{ item.image_url }}" alt="{{ item.name }}">
                                                {% else %}
                                                <div class="thumb-placeholder"><i class="bi bi-image"></i></div>
                                                {% endif %}
                                                <div class="quick-add"><i class="bi bi-plus-lg"></i></div>
                                            </div>
                                            <div class="card-body p-2 item-body">
                                                <div class="item-content">
                                                    <!-- Transparent Name Badge (Resizable) -->
                                                    <div class="transparent-name-badge" style="background: rgba(255,255,255,0.8); border-radius: 8px; padding: 4px 8px; text-align: center; backdrop-filter: blur(5px); font-size: var(--name-badge-size, 14px); font-weight: 600; color: #333; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                                        {{ item.name }}
                                                    </div>
                                                    <!-- Price removed as requested -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Special Items Vertical Section (Always Visible) -->
                    {% if special_items %}
                    <div class="special-items-integrated d-none d-md-flex flex-column" style="min-width: 280px; max-width: 320px;">
                        <div class="special-items-container">
                            <div class="row g-2">
                                {% for item in special_items %}
                                <div class="col-6">
                                    <div class="card modern-item special-item-customizable item-card {% if loop.index0 // 2 % 2 == 0 %}special-item-color-1{% else %}special-item-color-2{% endif %}" 
                                         data-item-id="{{ item.id }}" 
                                         data-item-name="{{ item.name }}" 
                                         data-item-price="{{ item.price }}"
                                         data-item-type="special"
                                         style="min-height: 100px; cursor: pointer; transition: all 0.3s ease;"
                                         title="Click to add to selected regular item">
                                        
                                        <!-- No customization icons for special items -->
                                        
                                        <!-- No image thumb for special items -->
                                        <div class="item-thumb" style="display: none;"></div>
                                        
                                        <div class="card-body p-2 item-body" style="display: flex; align-items: center; justify-content: center; text-align: center;">
                                            <div class="item-content" style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                                                <!-- Transparent Name Badge (same as regular items) -->
                                                <div class="transparent-name-badge" style="background: rgba(255,255,255,0.9); border-radius: 8px; padding: 6px 10px; text-align: center; backdrop-filter: blur(5px); font-size: 11px; font-weight: 600; color: #333; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                                    {{ item.name }}
                                                </div>
                                                <!-- Price removed as requested -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Order Cart and Calculator Column -->
    <div class="col-xl-4 col-lg-3 col-md-4">
        <div class="d-flex flex-column pos-right-column">
            <!-- Current Order Section -->
            <div class="card flex-grow-1 order-section">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-cart"></i> Current Order
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" id="recentOrdersBtn" data-bs-toggle="modal" data-bs-target="#recentOrdersModal">
                        <i class="bi bi-clock-history"></i> Recent
                    </button>
                </div>
                <div class="card-body d-flex flex-column" style="height: 500px;">
                    <div class="order-items flex-grow-1 order-items-container" id="orderItems" style="max-height: 350px; overflow-y: auto; padding-right: 8px;">
                        <p class="text-muted text-center">No items added yet</p>
                    </div>
                    
                    <div class="order-summary mt-auto">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Total:</strong>
                            <strong id="orderTotal">0.00 QAR</strong>
                        </div>
                        <!-- Order action buttons -->
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-danger w-100" id="clearOrderBtn">
                                    <i class="bi bi-trash"></i> Clear Order
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-success w-100" id="completeOrderBtn" disabled>
                                    <i class="bi bi-check-circle"></i> Complete Order
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Special Items Section -->
                    {% if special_items %}
                    <div class="d-md-none">
                        <hr>
                        <div class="special-requests-mobile">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div class="d-flex align-items-center gap-2" data-bs-toggle="collapse" data-bs-target="#mobileSpecialItems" style="cursor: pointer;">
                                    <span class="badge bg-gradient" style="background: linear-gradient(135deg, #6f42c1, #007bff);"><i class="bi bi-stars"></i></span>
                                    <h6 class="mb-0">Special Items</h6>
                                    <i class="bi bi-chevron-down"></i>
                                </div>
                                <button id="customizeSpecialBtnMobile" class="btn btn-sm p-1" style="width: 28px; height: 28px; font-size: 12px;" title="Customize Special Items">
                                    <i class="bi bi-sliders"></i>
                                </button>
                            </div>
                            <div class="collapse" id="mobileSpecialItems">
                                <div class="row g-2 justify-content-center">
                                    {% for item in special_items %}
                                    <div class="col-6 d-flex justify-content-center">
                                        <div class="card modern-item special-item-customizable item-card {% if loop.index0 // 2 % 2 == 0 %}special-item-color-1{% else %}special-item-color-2{% endif %}" 
                                             data-item-id="{{ item.id }}" 
                                             data-item-name="{{ item.name }}" 
                                             data-item-price="{{ item.price }}"
                                             data-item-type="special"
                                             style="min-height: 100px; width: 100%; cursor: pointer; transition: all 0.3s ease;"
                                             title="Click to add to selected regular item">
                                            
                                            <!-- No customization icons for special items -->
                                            
                                            <!-- No image thumb for special items -->
                                            <div class="item-thumb" style="display: none;"></div>
                                            
                                            <div class="card-body p-2 item-body" style="display: flex; align-items: center; justify-content: center; text-align: center;">
                                                <div class="item-content" style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                                                    <!-- Transparent Name Badge (same as regular items) -->
                                                    <div class="transparent-name-badge" style="background: rgba(255,255,255,0.9); border-radius: 8px; padding: 6px 10px; text-align: center; backdrop-filter: blur(5px); font-size: 11px; font-weight: 600; color: #333; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                                        {{ item.name }}
                                                    </div>
                                                    <!-- Price removed as requested -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- POS Calculator Section (Separate Container) -->
            <div class="card mt-3 calculator-section">
            <div class="card-header bg-primary text-white py-2">
                <h6 class="card-title mb-0 d-flex align-items-center">
                    <i class="bi bi-calculator me-2"></i>
                    <span id="calculatorTitle">POS Calculator</span>
                    <div class="ms-auto">
                        <span class="badge bg-light text-primary" id="calculatorMode">Price Mode</span>
                    </div>
                </h6>
            </div>
            <div class="card-body p-2">
                <!-- Calculator Display -->
                <div class="calculator-display mb-2">
                    <div class="input-group">
                        <span class="input-group-text bg-light">
                            <i class="bi bi-display" id="displayIcon"></i>
                        </span>
                        <input type="text" class="form-control text-end fw-bold" id="calculatorDisplay" 
                               value="0" readonly style="font-size: 1.1rem; background: #f8f9fa;">
                        <span class="input-group-text bg-light" id="calculatorUnit">QAR</span>
                    </div>
                    <div class="mt-1">
                        <small class="text-muted" id="calculatorHint">Select "Special Order" item to set price</small>
                    </div>
                </div>

                <!-- Mode Toggle Buttons -->
                <div class="calculator-modes mb-2">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm active" id="priceModeBtn">
                            <i class="bi bi-currency-dollar me-1"></i>Price
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" id="quantityModeBtn">
                            <i class="bi bi-x-lg me-1"></i>Quantity
                        </button>
                    </div>
                </div>

                <!-- Calculator Number Pad -->
                <div class="calculator-pad">
                    <div class="row g-1">
                        <!-- First Row -->
                        <div class="col-3">
                            <button class="btn btn-outline-secondary w-100 calc-btn" data-value="7">7</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-secondary w-100 calc-btn" data-value="8">8</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-secondary w-100 calc-btn" data-value="9">9</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-danger w-100 calc-btn" data-action="clear">
                                <i class="bi bi-backspace"></i>
                            </button>
                        </div>
                        
                        <!-- Second Row -->
                        <div class="col-3">
                            <button class="btn btn-outline-secondary w-100 calc-btn" data-value="4">4</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-secondary w-100 calc-btn" data-value="5">5</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-secondary w-100 calc-btn" data-value="6">6</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-warning w-100 calc-btn" data-action="decimal">.</button>
                        </div>
                        
                        <!-- Third Row -->
                        <div class="col-3">
                            <button class="btn btn-outline-secondary w-100 calc-btn" data-value="1">1</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-secondary w-100 calc-btn" data-value="2">2</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-secondary w-100 calc-btn" data-value="3">3</button>
                        </div>
                        <div class="col-3" rowspan="2">
                            <button class="btn btn-success w-100 calc-btn h-100" data-action="apply" id="applyBtn">
                                <i class="bi bi-check-lg"></i>
                            </button>
                        </div>
                        
                        <!-- Fourth Row -->
                        <div class="col-6">
                            <button class="btn btn-outline-secondary w-100 calc-btn" data-value="0">0</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-info w-100 calc-btn" data-action="reset">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Price Buttons (for Special Orders) -->
                <div class="quick-prices mt-2 d-none" id="quickPricesSection">
                    <div class="row g-1">
                        <div class="col-12">
                            <small class="text-muted">Quick Prices:</small>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-primary btn-sm w-100 quick-price-btn" data-price="5">5</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-primary btn-sm w-100 quick-price-btn" data-price="10">10</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-primary btn-sm w-100 quick-price-btn" data-price="15">15</button>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-outline-primary btn-sm w-100 quick-price-btn" data-price="20">20</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Recent Orders Modal -->
<div class="modal fade" id="recentOrdersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Recent Orders</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="recentOrdersList">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading recent orders...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Completion Modal -->
<div class="modal fade" id="orderCompletionModal" tabindex="-1" aria-labelledby="orderCompletionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="orderCompletionModalLabel">
                    <i class="bi bi-check-circle-fill me-2"></i>Complete Your Order
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row mb-4">
                        <div class="col-12 text-center">
                            <h6 class="text-muted mb-3">Please select service type and payment method</h6>
                        </div>
                    </div>
                    
                    <!-- Service Type Selection -->
                    <div class="row mb-4" id="serviceTypeSection">
                        <div class="col-12">
                            <label class="form-label fw-bold">
                                <i class="bi bi-geo-alt-fill text-primary me-2"></i>Service Type
                            </label>
                            <div class="row g-3">
                                <div class="col-md-3 col-6">
                                    <div class="service-option {% if current_user.role.value == 'waiter' %}disabled{% endif %}" data-service="take_away">
                                        <div class="card h-100 border-2 service-card {% if current_user.role.value == 'waiter' %}disabled-card{% endif %}">
                                            <div class="card-body text-center p-3">
                                                <i class="bi bi-bag-check display-6 text-warning mb-2"></i>
                                                <h6 class="card-title mb-0">Take Away</h6>
                                                <small class="text-muted">To Go</small>
                                                {% if current_user.role.value == 'waiter' %}
                                                    <div class="mt-1">
                                                        <span class="badge bg-danger">
                                                            <i class="bi bi-lock-fill"></i> Waiter Restricted
                                                        </span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="service-option {% if current_user.role.value == 'waiter' %}disabled{% endif %}" data-service="delivery">
                                        <div class="card h-100 border-2 service-card {% if current_user.role.value == 'waiter' %}disabled-card{% endif %}">
                                            <div class="card-body text-center p-3">
                                                <i class="bi bi-truck display-6 text-info mb-2"></i>
                                                <h6 class="card-title mb-0">Delivery</h6>
                                                <small class="text-muted">Home Delivery</small>
                                                {% if current_user.role.value == 'waiter' %}
                                                    <div class="mt-1">
                                                        <span class="badge bg-danger">
                                                            <i class="bi bi-lock-fill"></i> Waiter Restricted
                                                        </span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Table Selection (Shown only when On Table is selected) -->
                    <div class="row mb-4" id="tableSelectionSection" style="display: none;">
                        <div class="col-12">
                            <label class="form-label fw-bold">
                                <i class="bi bi-table text-primary me-2"></i>Select Table
                            </label>
                            <div class="table-buttons-grid-modal">
                                {% for table in tables %}
                                <button class="table-btn-modal {% if table.is_busy %}disabled-table{% endif %}" 
                                        data-table-id="{{ table.id }}" 
                                        data-table-number="{{ table.table_number }}"
                                        data-is-busy="{{ table.is_busy|lower }}"
                                        {% if table.is_busy %}disabled{% endif %}>
                                    <i class="bi bi-person-workspace"></i>
                                    <span class="table-number">{{ table.table_number }}</span>
                                    {% if table.is_busy %}
                                        <div class="table-status-overlay">
                                            <i class="bi bi-lock-fill"></i>
                                            <small>Busy</small>
                                        </div>
                                    {% endif %}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delivery Company Selection (Hidden by default) -->
                    <div class="row mb-4" id="deliveryCompanySection" style="display: none;">
                        <div class="col-12">
                            <label class="form-label fw-bold">
                                <i class="bi bi-building text-info me-2"></i>Delivery Company
                            </label>
                            <div class="row g-3" id="deliveryCompaniesContainer">
                                <!-- Delivery companies will be loaded dynamically -->
                                <div class="col-12 text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2 mb-0">Loading delivery companies...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cashier Assignment (Shown only for waiters) -->
                    {% if current_user.role.value == 'waiter' %}
                    <div class="row mb-4" id="cashierAssignmentSection">
                        <div class="col-12">
                            <label class="form-label fw-bold">
                                <i class="bi bi-person-badge text-success me-2"></i>Cashier Assignment
                            </label>
                            
                            <!-- PIN Entry Button -->
                            <div class="card border-warning" id="pinEntryCard">
                                <div class="card-body text-center p-4">
                                    <i class="bi bi-exclamation-triangle display-4 text-warning mb-3"></i>
                                    <h6 class="card-title mb-3 text-warning">⚠️ Cashier Assignment Required</h6>
                                    <p class="text-muted mb-3"><strong>You cannot send orders without cashier assignment.</strong><br>Select a cashier and enter their PIN to assign them to your orders.</p>
                                    <button type="button" class="btn btn-warning btn-lg" id="enterPinBtn">
                                        <i class="bi bi-person-plus me-2"></i>Select Cashier
                                    </button>
                                    <div class="mt-2">
                                        <small class="text-muted">Orders are blocked until cashier is assigned</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cashier Selection (Hidden initially) -->
                            <div class="card border-warning d-none" id="cashierSelectionCard">
                                <div class="card-body p-4">
                                    <div class="text-center mb-3">
                                        <i class="bi bi-people display-4 text-warning mb-2"></i>
                                        <h6 class="card-title">Select Cashier</h6>
                                        <p class="text-muted small">Admin: Choose which cashier should handle this waiter's orders</p>
                                    </div>
                                    <div class="row g-2" id="cashierOptionsContainer">
                                        <!-- Cashier options will be populated here -->
                                    </div>
                                    <div class="text-center mt-3">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="backToPinBtn">
                                            <i class="bi bi-arrow-left me-2"></i>Back to PIN
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Assigned Cashier Display (Hidden initially) -->
                            <div class="card border-success d-none" id="assignedCashierCard">
                                <div class="card-body text-center p-4">
                                    <i class="bi bi-check-circle display-4 text-success mb-3"></i>
                                    <h6 class="card-title mb-3">Cashier Assigned</h6>
                                    <p class="mb-2">Orders will be assigned to:</p>
                                    <h5 class="text-success mb-3" id="assignedCashierName">-</h5>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="changeCashierBtn">
                                        <i class="bi bi-arrow-repeat me-2"></i>Change Assignment
                                    </button>
                                </div>
                            </div>
                            
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Admin PIN verification ensures secure cashier assignment
                            </small>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Order Summary -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-receipt text-primary me-2"></i>Order Summary
                                    </h6>
                                    <div class="d-flex justify-content-between">
                                        <span>Total Amount:</span>
                                        <strong id="modalOrderTotal">0.00 QAR</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Service Type:</span>
                                        <strong id="selectedServiceType">Not Selected</strong>
                                    </div>
                                    <div class="d-flex justify-content-between" id="deliveryCompanyRow" style="display: none;">
                                        <span>Delivery Company:</span>
                                        <strong id="selectedDeliveryCompany">Not Selected</strong>
                                    </div>
                                    {% if current_user.role.value == 'waiter' %}
                                    <div class="d-flex justify-content-between" id="assignedCashierRow">
                                        <span>Assigned Cashier:</span>
                                        <strong id="selectedCashier">Not Selected</strong>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-success btn-lg" id="confirmOrderBtn" disabled>
                        <i class="bi bi-check-circle me-2"></i>Send to Cashier
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin PIN Entry Modal (for waiters) -->
<div class="modal fade" id="adminPinModal" tabindex="-1" aria-labelledby="adminPinModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="adminPinModalLabel">
                    <i class="bi bi-shield-lock me-2"></i>Admin PIN Required
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="bi bi-person-badge display-1 text-primary mb-3"></i>
                    <h6>Ask your admin to enter their PIN</h6>
                    <p class="text-muted">This will automatically assign your orders to the correct cashier</p>
                </div>
                
                <div class="mb-4">
                    <input type="password" 
                           class="form-control form-control-lg text-center" 
                           id="adminPinInput" 
                           maxlength="4" 
                           placeholder="••••"
                           style="font-size: 2rem; letter-spacing: 1rem; max-width: 200px; margin: 0 auto;">
                </div>
                
                <div id="pinVerificationResult"></div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="verifyPinBtn">
                    <i class="bi bi-check-circle me-2"></i>Verify PIN
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Customize Size Modal -->
<div class="modal fade" id="customizeSizeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-sliders me-2"></i>Customize Item Card Size</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Card Width (% of row)</label>
            <input type="range" id="widthSlider" min="10" max="100" step="5" class="form-range">
            <div class="d-flex justify-content-between small text-muted">
              <span>More columns</span><span id="widthValue">50%</span><span>Fewer columns</span>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Card Min Height (px)</label>
            <input type="range" id="heightSlider" min="80" max="500" step="10" class="form-range">
            <div class="d-flex justify-content-between small text-muted">
              <span>Shorter</span><span id="heightValue">160px</span><span>Taller</span>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Font Size (px)</label>
            <input type="range" id="fontSlider" min="10" max="32" step="1" class="form-range">
            <div class="d-flex justify-content-between small text-muted">
              <span>Smaller</span><span id="fontValue">14px</span><span>Larger</span>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Name Badge Size (0.5x - 2x)</label>
            <input type="range" id="nameScaleSlider" min="0.5" max="2" step="0.05" class="form-range">
            <div class="d-flex justify-content-between small text-muted">
              <span>Smaller</span><span id="nameScaleValue">1.0x</span><span>Larger</span>
            </div>
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="showImagesSwitch" checked>
              <label class="form-check-label" for="showImagesSwitch">Show Images (hide to remove image section)</label>
            </div>
          </div>
        </div>
        <hr>
        <div>
          <div class="mb-2 d-flex align-items-center gap-2"><i class="bi bi-eye"></i><strong> Live Preview</strong></div>
          <div id="previewGrid" class="row g-2">
            <div class="preview-col" style="flex: 0 0 50%; max-width: 50%;">
              <div class="card modern-item" style="min-height: 160px;">
                <div class="item-thumb"><div class="thumb-placeholder"><i class="bi bi-image"></i></div></div>
                <div class="card-body p-2 item-body"><div class="item-content"><h6 class="card-title mb-1"><span class="item-name name-badge">Sample Item</span></h6><div class="price-tag-container"><span class="price-tag">12.00 QAR</span></div></div></div>
              </div>
            </div>
            <div class="preview-col" style="flex: 0 0 50%; max-width: 50%;">
              <div class="card modern-item" style="min-height: 160px;">
                <div class="item-thumb"><div class="thumb-placeholder"><i class="bi bi-image"></i></div></div>
                <div class="card-body p-2 item-body"><div class="item-content"><h6 class="card-title mb-1"><span class="item-name name-badge">Another Item</span></h6><div class="price-tag-container"><span class="price-tag">18.00 QAR</span></div></div></div>
              </div>
            </div>
          </div>
          <small class="text-muted">Changes are applied immediately to the POS and saved for your account in this branch.</small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Customize Special Items Modal -->
<div class="modal fade" id="customizeSpecialModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-sliders me-2"></i>Customize Special Items</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Button Width (%)</label>
            <input type="range" id="specialWidthSlider" min="40" max="100" step="5" class="form-range">
            <div class="d-flex justify-content-between small text-muted">
              <span>Narrower</span><span id="specialWidthValue">100%</span><span>Wider</span>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Sidebar Width (%)</label>
            <input type="range" id="specialSidebarWidthSlider" min="60" max="100" step="5" class="form-range">
            <div class="d-flex justify-content-between small text-muted">
              <span>Narrower</span><span id="specialSidebarWidthValue">100%</span><span>Wider</span>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Button Height (px)</label>
            <input type="range" id="specialHeightSlider" min="40" max="120" step="4" class="form-range">
            <div class="d-flex justify-content-between small text-muted">
              <span>Shorter</span><span id="specialHeightValue">40px</span><span>Taller</span>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Font Size (px)</label>
            <input type="range" id="specialFontSlider" min="8" max="20" step="1" class="form-range">
            <div class="d-flex justify-content-between small text-muted">
              <span>Smaller</span><span id="specialFontValue">11px</span><span>Larger</span>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Button Spacing (px)</label>
            <input type="range" id="specialSpacingSlider" min="4" max="16" step="2" class="form-range">
            <div class="d-flex justify-content-between small text-muted">
              <span>Closer</span><span id="specialSpacingValue">8px</span><span>Further</span>
            </div>
          </div>
        </div>
        <hr>
        <div>
          <div class="mb-2 d-flex align-items-center gap-2"><i class="bi bi-eye"></i><strong> Live Preview</strong></div>
          <div id="specialPreviewGrid" class="special-preview-container">
            <button class="btn btn-outline-primary special-preview-btn">
              <span class="fw-bold">Sample Special Item</span>
            </button>
            <button class="btn btn-outline-primary special-preview-btn">
              <span class="fw-bold">Another Item</span>
            </button>
          </div>
          <small class="text-muted">Changes are applied immediately to the special items and saved for your account in this branch.</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-outline-secondary" id="resetSpecialPrefsBtn">Reset to Defaults</button>
        <button type="button" class="btn btn-primary" id="saveSpecialPrefsBtn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Falafel Hab Custom Price Modal -->
<div class="modal fade" id="falafelHabPriceModal" tabindex="-1" aria-labelledby="falafelHabPriceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="falafelHabPriceModalLabel">
                    <i class="bi bi-calculator me-2"></i>Set Price for Falafel Hab
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <h6 class="text-muted">Enter custom price for Falafel Hab</h6>
                </div>
                
                <!-- Price Display -->
                <div class="mb-3">
                    <label for="falafelHabPrice" class="form-label">Price (QAR)</label>
                    <input type="text" class="form-control form-control-lg text-center" id="falafelHabPrice" 
                           placeholder="0.00" readonly style="font-size: 1.5rem; font-weight: bold;">
                </div>
                
                <!-- Calculator Buttons -->
                <div class="row g-2">
                    <!-- Number buttons -->
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 calc-btn" data-value="7">7</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 calc-btn" data-value="8">8</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 calc-btn" data-value="9">9</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-danger w-100" id="calcClear">C</button>
                    </div>
                    
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 calc-btn" data-value="4">4</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 calc-btn" data-value="5">5</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 calc-btn" data-value="6">6</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-warning w-100" id="calcBackspace">⌫</button>
                    </div>
                    
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 calc-btn" data-value="1">1</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 calc-btn" data-value="2">2</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 calc-btn" data-value="3">3</button>
                    </div>
                    <div class="col-3" rowspan="2">
                        <button type="button" class="btn btn-success w-100 h-100" id="addFalafelHab" style="height: 76px;">
                            <i class="bi bi-plus-circle me-1"></i>Add
                        </button>
                    </div>
                    
                    <div class="col-6">
                        <button type="button" class="btn btn-outline-primary w-100 calc-btn" data-value="0">0</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 calc-btn" data-value=".">.</button>
                    </div>
                </div>
                
                <!-- Quick Price Buttons -->
                <div class="mt-3">
                    <h6 class="text-muted mb-2">Quick Prices:</h6>
                    <div class="row g-2">
                        <div class="col-3">
                            <button type="button" class="btn btn-outline-secondary w-100 quick-price-btn" data-price="5.00">5.00</button>
                        </div>
                        <div class="col-3">
                            <button type="button" class="btn btn-outline-secondary w-100 quick-price-btn" data-price="8.00">8.00</button>
                        </div>
                        <div class="col-3">
                            <button type="button" class="btn btn-outline-secondary w-100 quick-price-btn" data-price="10.00">10.00</button>
                        </div>
                        <div class="col-3">
                            <button type="button" class="btn btn-outline-secondary w-100 quick-price-btn" data-price="15.00">15.00</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmFalafelHab">
                    <i class="bi bi-check-circle me-1"></i>Add to Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Special Order Custom Price Modal -->
<div class="modal fade" id="specialOrderPriceModal" tabindex="-1" aria-labelledby="specialOrderPriceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="specialOrderPriceModalLabel">
                    <i class="bi bi-calculator me-2"></i>Set Price for Special Order
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <h6 class="text-muted">Enter custom price for Special Order</h6>
                </div>
                
                <!-- Price Display -->
                <div class="mb-3">
                    <label for="specialOrderPrice" class="form-label">Price (QAR)</label>
                    <input type="text" class="form-control form-control-lg text-center" id="specialOrderPrice" 
                           placeholder="0.00" readonly style="font-size: 1.5rem; font-weight: bold;">
                </div>
                
                <!-- Calculator Buttons -->
                <div class="row g-2">
                    <!-- Number buttons -->
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 special-calc-btn" data-value="7">7</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 special-calc-btn" data-value="8">8</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 special-calc-btn" data-value="9">9</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-danger w-100" id="specialCalcClear">C</button>
                    </div>
                    
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 special-calc-btn" data-value="4">4</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 special-calc-btn" data-value="5">5</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 special-calc-btn" data-value="6">6</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-warning w-100" id="specialCalcBackspace">⌫</button>
                    </div>
                    
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 special-calc-btn" data-value="1">1</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 special-calc-btn" data-value="2">2</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 special-calc-btn" data-value="3">3</button>
                    </div>
                    <div class="col-3" rowspan="2">
                        <button type="button" class="btn btn-success w-100 h-100" id="addSpecialOrder" style="height: 76px;">
                            <i class="bi bi-plus-circle me-1"></i>Add
                        </button>
                    </div>
                    
                    <div class="col-6">
                        <button type="button" class="btn btn-outline-primary w-100 special-calc-btn" data-value="0">0</button>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-primary w-100 special-calc-btn" data-value=".">.</button>
                    </div>
                </div>
                
                <!-- Quick Price Buttons -->
                <div class="mt-3">
                    <h6 class="text-muted mb-2">Quick Prices:</h6>
                    <div class="row g-2">
                        <div class="col-3">
                            <button type="button" class="btn btn-outline-secondary w-100 special-quick-price-btn" data-price="10.00">10.00</button>
                        </div>
                        <div class="col-3">
                            <button type="button" class="btn btn-outline-secondary w-100 special-quick-price-btn" data-price="15.00">15.00</button>
                        </div>
                        <div class="col-3">
                            <button type="button" class="btn btn-outline-secondary w-100 special-quick-price-btn" data-price="20.00">20.00</button>
                        </div>
                        <div class="col-3">
                            <button type="button" class="btn btn-outline-secondary w-100 special-quick-price-btn" data-price="25.00">25.00</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSpecialOrder">
                    <i class="bi bi-check-circle me-1"></i>Add to Order
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
/* Dynamic item sizing applied by JS */
.pos-item-col.dyn-width { flex: 0 0 var(--pos-card-width, 50%); max-width: var(--pos-card-width, 50%); }
.modern-item.dyn-height { min-height: var(--pos-card-min-height, 160px); }
.modern-item.dyn-height .item-thumb { height: calc(var(--pos-card-min-height, 160px) * 0.56); }
.modern-item.dyn-height .item-thumb img, 
.modern-item.dyn-height .thumb-placeholder { height: calc(var(--pos-card-min-height, 160px) * 0.56); }

/* Advanced Customization Features */
:root {
  --name-badge-size: 14px;
  --default-item-bg-0: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%);
  --default-item-bg-1: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
  --default-item-bg-2: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
  --default-item-bg-3: linear-gradient(135deg, #f8d7da 0%, #f1c0c7 100%);
  --default-item-bg-4: linear-gradient(135deg, #e2e3f0 0%, #d6d8e5 100%);
  --default-item-bg-5: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
  --default-item-bg-6: linear-gradient(135deg, #f4f4f4 0%, #e9ecef 100%);
  --default-item-bg-7: linear-gradient(135deg, #cff4fc 0%, #b6effb 100%);
  
  /* Special Items Customization Variables */
  --special-width-pct: 100;
  --special-height-px: 40;
  --special-font-px: 11;
  --special-spacing-px: 8;
  --special-sidebar-width: 100;
}

/* Transparent Name Badge Styling */
.transparent-name-badge {
  font-size: var(--name-badge-size, 14px) !important;
  transition: all 0.3s ease;
  word-wrap: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
}

/* Edit Mode Styling */
.edit-mode-active .item-card {
  cursor: grab !important;
  user-select: none;
}

.edit-mode-active .item-card:active {
  cursor: grabbing !important;
}

.edit-mode-active .edit-mode-controls {
  display: block !important;
}

.edit-mode-active .item-card:hover {
  transform: translateY(-4px) !important;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

/* Drag and Drop Styling */
.dragging {
  opacity: 0.5;
  transform: rotate(5deg) scale(1.05);
  z-index: 1000;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
}

.drag-over {
  border: 3px dashed #007bff !important;
  background: rgba(0, 123, 255, 0.1) !important;
}

/* Color Picker Button */
.color-picker-btn {
  background: rgba(255, 255, 255, 0.9) !important;
  border: 1px solid rgba(0, 0, 0, 0.2) !important;
  backdrop-filter: blur(5px);
}

.color-picker-btn:hover {
  background: rgba(255, 255, 255, 1) !important;
  transform: scale(1.1);
}

/* Touch Screen Double-Tap Indicator */
.double-tap-indicator {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 123, 255, 0.9);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  z-index: 20;
  animation: fadeInOut 1s ease-in-out;
}

@keyframes fadeInOut {
  0%, 100% { opacity: 0; }
  50% { opacity: 1; }
}

/* Hide images when toggled */
.no-images .modern-item .item-thumb { display: none !important; }
/* Center content when images are hidden */
.no-images .modern-item .item-body { display: flex; align-items: center; justify-content: center; text-align: center; }
.no-images .modern-item .item-content { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
/* Special Items Integrated Layout Styling */
.special-items-integrated {
    position: sticky;
    top: 20px;
    align-self: flex-start;
    overflow-y: visible;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* Internet Explorer 10+ */
}

/* Hide scrollbar for WebKit browsers (Chrome, Safari, Edge) */
.special-items-integrated::-webkit-scrollbar {
    display: none;
}

.special-items-container {
    height: auto;
}

/* Special Item Button Styling with CSS Variables */
.special-item-customizable {
    width: calc(var(--special-width-pct, 100) * 1%) !important;
    min-height: calc(var(--special-height-px, 40) * 1px) !important;
    font-size: calc(var(--special-font-px, 11) * 1px) !important;
    margin-bottom: calc(var(--special-spacing-px, 8) * 1px) !important;
    transition: all 0.2s ease;
    border: 1px solid #007bff;
    background: white;
    color: #007bff;
    padding: 8px 10px;
    border-radius: 8px;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
}

/* Ensure font size applies to all text inside special buttons with higher specificity */
.special-item-customizable span,
.special-item-customizable .fw-bold,
.special-item-customizable * {
    font-size: calc(var(--special-font-px, 11) * 1px) !important;
    line-height: 1.2 !important;
}

/* Override any Bootstrap font size classes */
.special-item-customizable.btn {
    font-size: calc(var(--special-font-px, 11) * 1px) !important;
}

/* Desktop specific font size fix */
@media (min-width: 992px) {
    .special-item-customizable {
        font-size: calc(var(--special-font-px, 11) * 1px) !important;
    }
    
    .special-item-customizable span,
    .special-item-customizable .fw-bold,
    .special-item-customizable * {
        font-size: calc(var(--special-font-px, 11) * 1px) !important;
    }
}

.special-item-customizable:hover {
    background: #007bff;
    color: white;
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

.special-item-customizable:active {
    transform: translateX(0);
}

/* Mobile Special Items Styling */
.special-requests-mobile .special-item-customizable {
    transform: none;
}

.special-requests-mobile .special-item-customizable:hover {
    transform: translateY(-1px);
}

/* Special items alternating colors */
.special-item-color-1 {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%) !important;
    border-left: 4px solid #2196f3 !important;
}

.special-item-color-2 {
    background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%) !important;
    border-left: 4px solid #9c27b0 !important;
}

/* Special Items Preview Styling */
.special-preview-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-width: 300px;
}

.special-preview-btn {
    width: calc(var(--special-width-pct, 100) * 1%) !important;
    min-height: calc(var(--special-height-px, 40) * 1px) !important;
    font-size: calc(var(--special-font-px, 11) * 1px) !important;
    margin-bottom: calc(var(--special-spacing-px, 8) * 1px) !important;
    transition: all 0.2s ease;
}
/* Ensure layout remains responsive regardless of custom sizes */
@media (max-width: 767.98px) {
  .pos-item-col.dyn-width { flex: 0 0 50% !important; max-width: 50% !important; }
}
/* Collapsible navbar on hover - only for desktop screens */
@media (min-width: 992px) {
    .collapsible-navbar {
        height: 20px;
        overflow: hidden;
        transition: height 0.3s ease;
    }
    .collapsible-navbar:hover {
        height: 56px;
    }
    .collapsible-navbar .navbar-nav {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .collapsible-navbar:hover .navbar-nav {
        opacity: 1;
    }
    .collapsible-navbar .navbar-brand {
        font-size: 14px;
        line-height: 20px;
    }
    .collapsible-navbar:hover .navbar-brand {
        font-size: 1.25rem;
        line-height: normal;
    }
}

/* Mobile and tablet navbar - normal behavior */
@media (max-width: 991.98px) {
    .collapsible-navbar {
        height: auto !important;
        overflow: visible !important;
    }
    .collapsible-navbar .navbar-nav {
        opacity: 1 !important;
    }
    .collapsible-navbar .navbar-brand {
        font-size: 1.25rem !important;
        line-height: normal !important;
    }
    .collapsible-navbar .navbar-collapse {
        background: rgba(13, 110, 253, 0.95);
        border-radius: 8px;
        margin-top: 8px;
        padding: 10px;
    }
}

/* Table Selection Buttons - Modal Version */
.table-buttons-grid-modal {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 12px;
    padding: 8px;
}

.table-btn-modal {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid #dee2e6;
    border-radius: 12px;
    padding: 15px;
    margin: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 80px;
    position: relative;
}

.table-btn-modal.disabled-table {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    border: 2px solid #f5c6cb;
    cursor: not-allowed;
    opacity: 0.7;
}

.table-btn-modal.disabled-table:hover {
    transform: none;
    box-shadow: none;
}

.table-status-overlay {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border-radius: 6px;
    padding: 2px 6px;
    font-size: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    line-height: 1.2;
}

.table-status-overlay i {
    font-size: 12px;
    margin-bottom: 1px;
}

.table-btn-modal:hover {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-color: #2196f3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
}

.table-btn-modal.selected {
    background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
    border-color: #4caf50;
    color: #2e7d32;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.table-btn-modal i {
    font-size: 20px;
    opacity: 0.8;
}

.table-btn-modal .table-number {
    font-size: 14px;
    font-weight: 600;
    line-height: 1;
}

.table-btn {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid #dee2e6;
    border-radius: 12px;
    padding: 12px 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
    cursor: pointer;
    min-height: 70px;
    position: relative;
}

.table-btn:hover {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-color: #2196f3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
}

.table-btn.selected {
    background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
    border-color: #4caf50;
    color: #2e7d32;
}

.table-btn.occupied {
    background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);
    border-color: #f44336;
    color: #c62828;
}

.table-btn i {
    font-size: 18px;
    opacity: 0.8;
}

.table-btn .table-number {
    font-size: 12px;
    font-weight: 600;
    line-height: 1;
}

.table-btn.selected i,
.table-btn.selected .table-number {
    color: #2e7d32;
}

.table-btn.occupied i,
.table-btn.occupied .table-number {
    color: #c62828;
}

/* Order Items Styling */
.order-item-card {
    padding: 8px 12px;
    border-radius: 8px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
}

.order-item-card:hover {
    background: #e9ecef;
    border-color: #dee2e6;
}

.order-item-card .item-info {
    flex: 1;
    min-width: 0;
}

.order-item-card .item-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: #495057;
    line-height: 1.2;
    margin-bottom: 2px;
}

.order-item-card .item-details {
    font-size: 0.75rem;
    color: #6c757d;
    line-height: 1.1;
}

.order-item-card .item-actions {
    flex-shrink: 0;
}

.order-item-card .item-price {
    font-size: 0.8rem;
    font-weight: 600;
    color: #28a745;
    min-width: 60px;
    text-align: right;
}

.order-item-card .remove-item {
    padding: 2px 6px;
    font-size: 0.75rem;
    border-radius: 4px;
    min-width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.order-item-card .remove-item i {
    font-size: 0.7rem;
}

/* Special item styling */
.order-item-card.special-item {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
    border-color: #4caf50;
}

.order-item-card.special-item .item-name {
    color: #2e7d32;
}

.order-item-card.special-item .item-price {
    color: #4caf50;
    font-weight: 700;
}

/* Responsive layout adjustments */
@media (max-width: 767.98px) {
    /* Mobile layout - stack columns */
    .container-fluid {
        padding: 0.5rem;
    }
    
    /* Adjust card spacing */
    .card {
        margin-bottom: 1rem;
    }
    
    /* Hide integrated special items on mobile */
    .special-items-integrated {
        display: none !important;
    }
    
    /* Mobile special items chevron animation */
    .special-requests-mobile [data-bs-toggle="collapse"] .bi-chevron-down {
        transition: transform 0.3s ease;
    }
    
    .special-requests-mobile [data-bs-toggle="collapse"][aria-expanded="true"] .bi-chevron-down {
        transform: rotate(180deg);
    }
    
    /* Mobile optimizations */
    .modern-item {
        min-height: 120px !important;
    }
    
    .special-item-customizable {
        min-height: 48px !important;
        font-size: 12px !important;
        padding: 10px 8px !important;
    }
    
    /* Touch-friendly buttons */
    .btn {
        min-height: 44px;
        padding: 8px 12px;
    }
    
    /* Larger tap targets for touch */
    .nav-link {
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Make category tabs scrollable on mobile */
    #categoryTabs {
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    #categoryTabs .nav-item {
        flex: 0 0 auto;
    }
    
    #categoryTabs .nav-link {
        white-space: nowrap;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }
    
    /* Adjust item cards for mobile */
    .modern-item {
        margin-bottom: 0.75rem;
        min-height: 140px;
    }
    
    .modern-item .item-thumb {
        height: 70px;
    }
    
    .modern-item .item-thumb img {
        height: 70px;
    }
    
    .modern-item .thumb-placeholder {
        height: 70px;
        font-size: 18px;
    }
    
    .modern-item .item-name {
        font-size: 0.9rem !important;
        min-height: 2.4em;
    }
    
    .modern-item .price-tag {
        font-size: 0.8rem;
        padding: 3px 6px;
    }
    
    /* Special requests chips - smaller on mobile */
    .chip {
        font-size: 11px;
        padding: 4px 8px;
    }
    
    /* Order section adjustments */
    .order-items {
        max-height: 300px;
        overflow-y: auto;
    }
    
    /* Table buttons on mobile */
    .table-buttons-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .table-btn {
        min-height: 50px;
        padding: 8px 4px;
    }
    
    .table-btn i {
        font-size: 14px;
    }
    
    .table-btn .table-number {
        font-size: 10px;
    }
}

@media (min-width: 768px) and (max-width: 991.98px) {
    /* Tablet layout adjustments */
    .modern-item .item-thumb {
        height: 90px;
    }
    
    .modern-item .item-thumb img {
        height: 90px;
    }
    
    .modern-item .thumb-placeholder {
        height: 90px;
        font-size: 24px;
    }
    
    /* Tablet special items integrated adjustments */
    .special-items-integrated {
        min-width: 120px;
        max-width: 150px;
    }
    
    .special-items-integrated .modern-item {
        font-size: 10px !important;
        min-height: 100px !important;
    }
    
    /* Tablet touch optimizations */
    .btn {
        min-height: 42px;
        padding: 8px 12px;
    }
    
    .nav-link {
        min-height: 44px;
        padding: 8px 16px;
    }
    
    /* Adjust flex layout for tablet */
    .d-flex.gap-3 {
        gap: 1rem !important;
    }
}

/* Large desktop optimizations */
@media (min-width: 1200px) {
    /* Optimize spacing for XL screens */
    .special-items-integrated {
        min-width: 160px;
        max-width: 200px;
    }
    
    .special-items-integrated .modern-item {
        font-size: 12px !important;
        min-height: 120px !important;
    }
    
    .special-items-container {
        max-height: 75vh !important;
    }
    
    /* Increase gap for better spacing on large screens */
    .d-flex.gap-3 {
        gap: 2rem !important;
    }
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
    /* Touch devices */
    .modern-item:hover {
        transform: none;
    }
    
    .modern-item:active {
        transform: scale(0.98);
    }
    
    .chip:hover {
        background: #fff;
        color: #1976d2;
    }
    
    .chip:active {
        background: #2196f3;
        color: #fff;
    }
    
    /* Larger touch targets */
    .btn {
        min-height: 44px;
    }
    
    .nav-link {
        min-height: 44px;
        display: flex;
        align-items: center;
    }
}

/* Modern item cards with comfortable category colors */
.modern-item {
    border: 0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 14px rgba(0,0,0,0.06);
    cursor: pointer;
    transition: transform .15s ease, box-shadow .15s ease;
    height: auto;
    min-height: 160px;
}
.modern-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}
.modern-item .item-thumb { 
    position: relative; 
    height: 90px; 
    flex-shrink: 0;
}
.modern-item .item-thumb img { 
    width: 100%; 
    height: 90px; 
    object-fit: cover; 
    display: block; 
}
.modern-item .thumb-placeholder { 
    width: 100%; 
    height: 90px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    color: #bdbdbd; 
    font-size: 24px; 
}
.modern-item .quick-add { 
    position: absolute; 
    right: 6px; 
    bottom: 6px; 
    background: rgba(255,255,255,0.9); 
    border-radius: 6px; 
    padding: 3px 5px; 
    font-size: 12px; 
    color: #222; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.15); 
}

.modern-item .item-body {
    padding: 8px !important;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.modern-item .item-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    gap: 6px;
}

.modern-item .item-name {
    font-size: 1rem !important;
    font-weight: 600 !important;
    line-height: 1.3 !important;
    color: #2c3e50 !important;
    margin: 0 !important;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: visible;
    text-overflow: unset;
    white-space: normal;
    min-height: 2.6em;
}

.modern-item .price-tag-container {
    margin-top: auto;
    display: flex;
    justify-content: center;
}

.modern-item .price-tag { 
    border-radius: 8px; 
    padding: 4px 8px; 
    font-size: 0.875rem; 
    font-weight: 700; 
    color: white;
    text-align: center;
    min-width: 70px;
}

/* Selected item state */
.modern-item.item-selected {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
    border: 2px solid #28a745;
}

.modern-item.item-selected .quick-add {
    background: #28a745;
    color: white;
}

.modern-item.item-selected .item-name {
    color: #155724 !important;
}

.modern-item.item-selected .price-tag {
    background: #28a745 !important;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

/* Comfortable eye-friendly category colors */
.modern-item.category-color-0 { 
    background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%); 
    border-left: 4px solid #17a2b8;
}
.modern-item.category-color-0 .item-thumb { background: #e8f4f8; }
.modern-item.category-color-0 .price-tag { background: #17a2b8; }

.modern-item.category-color-1 { 
    background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); 
    border-left: 4px solid #28a745;
}
.modern-item.category-color-1 .item-thumb { background: #e8f5e8; }
.modern-item.category-color-1 .price-tag { background: #28a745; }

.modern-item.category-color-2 { 
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); 
    border-left: 4px solid #ffc107;
}
.modern-item.category-color-2 .item-thumb { background: #fff3cd; }
.modern-item.category-color-2 .price-tag { background: #e0a800; color: white; }

.modern-item.category-color-3 { 
    background: linear-gradient(135deg, #f8d7da 0%, #f1c0c7 100%); 
    border-left: 4px solid #dc3545;
}
.modern-item.category-color-3 .item-thumb { background: #f8d7da; }
.modern-item.category-color-3 .price-tag { background: #dc3545; }

.modern-item.category-color-4 { 
    background: linear-gradient(135deg, #e2e3f0 0%, #d6d8e5 100%); 
    border-left: 4px solid #6f42c1;
}
.modern-item.category-color-4 .item-thumb { background: #e2e3f0; }
.modern-item.category-color-4 .price-tag { background: #6f42c1; }

.modern-item.category-color-5 { 
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); 
    border-left: 4px solid #20c997;
}
.modern-item.category-color-5 .item-thumb { background: #d1ecf1; }
.modern-item.category-color-5 .price-tag { background: #20c997; }

.modern-item.category-color-6 { 
    background: linear-gradient(135deg, #f4f4f4 0%, #e9ecef 100%); 
    border-left: 4px solid #6c757d;
}
.modern-item.category-color-6 .item-thumb { background: #f4f4f4; }
.modern-item.category-color-6 .price-tag { background: #6c757d; }

.modern-item.category-color-7 { 
    background: linear-gradient(135deg, #cff4fc 0%, #b6effb 100%); 
    border-left: 4px solid #0dcaf0;
}
.modern-item.category-color-7 .item-thumb { background: #cff4fc; }
.modern-item.category-color-7 .price-tag { background: #0dcaf0; }

/* Inline special requests chips */
.special-requests-inline {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    border: 1px solid rgba(33,150,243,0.35);
    border-radius: 12px;
    padding: 10px 12px;
}
.special-badge { background: linear-gradient(135deg,#2196f3,#9c27b0) !important; }
.chips { display: flex; flex-wrap: wrap; gap: 8px; }
.chip { border: 1px solid #2196f3; color:#1976d2; background:#fff; border-radius: 999px; padding: 6px 10px; font-size: 12px; transition: all .2s ease; }
.chip:hover { background:#2196f3; color:#fff; box-shadow: 0 4px 10px rgba(33,150,243,.3); }
.chip.selected { background:#4caf50; border-color:#4caf50; color:#fff; }

/* Special Requests Section Styling */
.special-requests-section {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    border: 2px solid #2196f3;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
    position: relative;
    overflow: hidden;
}

.special-requests-section::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, #2196f3, #9c27b0, #2196f3);
    border-radius: 12px;
    z-index: -1;
    animation: borderGlow 3s ease-in-out infinite alternate;
}

@keyframes borderGlow {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
}

.special-requests-header h6 {
    color: #1976d2 !important;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.special-items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 8px;
    margin-top: 10px;
}

.special-item-btn {
    border: 2px solid #2196f3 !important;
    background: white !important;
    color: #1976d2 !important;
    font-weight: 500;
    font-size: 11px;
    padding: 8px 6px;
    border-radius: 8px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.special-item-btn:hover {
    background: #2196f3 !important;
    color: white !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
}

.special-item-btn:active {
    transform: translateY(0);
}

.special-item-btn.selected {
    background: #4caf50 !important;
    border-color: #4caf50 !important;
    color: white !important;
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    transform: scale(1.02);
}

.special-item-btn .bi-plus-circle {
    margin-right: 4px;
}

/* Order item styling for special items */
.order-item.special-item {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
    border-left: 4px solid #4caf50;
    padding: 8px;
    margin: 4px 0;
    border-radius: 6px;
}

.order-item.special-item .item-name {
    color: #2e7d32;
    font-weight: 500;
}

.order-item.special-item .item-price {
    color: #4caf50;
    font-weight: 600;
}

/* Order Completion Modal Styles */
.service-card, .delivery-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border-color: #dee2e6 !important;
}

.service-card:hover, .delivery-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #007bff !important;
}

.service-option.selected .service-card,
.delivery-option.selected .delivery-card {
    border-color: #28a745 !important;
    background-color: #f8fff9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40,167,69,0.2);
}

.service-option.selected .service-card i,
.delivery-option.selected .delivery-card i {
    color: #28a745 !important;
}

.service-option.selected .service-card .card-title,
.delivery-option.selected .delivery-card .card-title {
    color: #28a745 !important;
}

/* Disabled Service Cards */
.service-option.disabled .service-card,
.delivery-option.disabled .delivery-card {
    cursor: not-allowed !important;
    opacity: 0.6;
    background-color: #f8f9fa;
    border-color: #dee2e6 !important;
}

.service-option.disabled .service-card:hover,
.delivery-option.disabled .delivery-card:hover {
    transform: none !important;
    box-shadow: none !important;
    border-color: #dee2e6 !important;
}

.service-option.disabled .service-card i,
.delivery-option.disabled .delivery-card i {
    opacity: 0.5;
}

.service-option.disabled .service-card .card-title,
.service-option.disabled .service-card .text-muted,
.delivery-option.disabled .delivery-card .card-title,
.delivery-option.disabled .delivery-card .text-muted {
    opacity: 0.7;
}

.disabled-card {
    position: relative;
}

.disabled-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 10px,
        rgba(255,255,255,0.3) 10px,
        rgba(255,255,255,0.3) 20px
    );
    pointer-events: none;
    z-index: 1;
}

/* POS Calculator Styling */
.calculator-display input {
    font-family: 'Courier New', monospace;
    letter-spacing: 1px;
    font-size: 1.4rem;
    padding: 12px;
    font-weight: bold;
}

.calc-btn {
    min-height: 55px;
    font-weight: 700;
    font-size: 1.2rem;
    transition: all 0.2s ease;
    border-radius: 8px;
    border-width: 2px;
}

.calc-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.calc-btn:active {
    transform: translateY(0);
}

.calc-btn[data-action="apply"] {
    background: linear-gradient(135deg, #28a745, #20c997);
    border-color: #28a745;
    color: white;
    min-height: 60px;
    font-size: 1.3rem;
}

.calc-btn[data-action="apply"]:hover {
    background: linear-gradient(135deg, #218838, #1ea085);
    border-color: #218838;
}

.calc-btn[data-action="clear"] {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
    border-color: #dc3545;
    color: white;
    font-size: 1.1rem;
}

.calc-btn[data-action="clear"]:hover {
    background: linear-gradient(135deg, #c82333, #e8650e);
    border-color: #c82333;
}

.calc-btn[data-action="reset"] {
    background: linear-gradient(135deg, #17a2b8, #6610f2);
    border-color: #17a2b8;
    color: white;
    font-size: 1.1rem;
}

.calc-btn[data-action="reset"]:hover {
    background: linear-gradient(135deg, #138496, #520dc2);
    border-color: #138496;
}

.calc-btn[data-action="decimal"] {
    font-size: 1.5rem;
    font-weight: 800;
}

.quick-price-btn {
    min-height: 40px;
    font-size: 14px;
    font-weight: 700;
    border-width: 2px;
}

.quick-price-btn:hover {
    background: #007bff;
    border-color: #007bff;
    color: white;
}

/* Calculator Mode Styling */
.calculator-modes .btn {
    min-height: 45px;
    font-size: 1.1rem;
    font-weight: 600;
    border-width: 2px;
}

.calculator-modes .btn.active {
    background: #007bff;
    border-color: #007bff;
    color: white;
}

#calculatorMode {
    font-size: 12px;
    padding: 4px 8px;
    font-weight: 600;
}

#calculatorTitle {
    font-size: 1.1rem;
    font-weight: 700;
}

.calculator-display .input-group-text {
    font-size: 1.2rem;
    padding: 8px 12px;
}

#calculatorHint {
    font-size: 13px;
    font-weight: 500;
}

/* Height Distribution and Layout */
.pos-right-column {
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* Match the height of the category items container */
.pos-right-column {
    min-height: calc(100vh - 200px);
}

.order-section {
    flex: 1.3;
    min-height: 0;
    display: flex;
    flex-direction: column;
}

.order-section .card-body {
    flex: 1;
    min-height: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    padding: 1rem;
    position: relative;
}

.order-items-container {
    overflow-y: auto;
    flex: 1;
    min-height: 150px;
    max-height: none;
    padding: 8px 0;
    margin-bottom: 0;
}

.order-summary {
    flex-shrink: 0;
    position: sticky;
    bottom: 0;
    z-index: 5;
    margin-top: auto;
    padding: 12px;
    background: #ffffff;
    border-top: 1px solid #e9ecef;
    border-radius: 0 0 6px 6px;
    box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
}

.calculator-section {
    flex: 1.7;
    min-height: 350px;
    max-height: 550px;
    display: flex;
    flex-direction: column;
}

.calculator-section .card-body {
    flex: 1;
    overflow-y: auto;
    min-height: 350px;
}

/* Order item selection for calculator */
.order-item.calculator-selected {
    border: 2px solid #007bff !important;
    background: rgba(0, 123, 255, 0.1) !important;
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.3) !important;
}

/* Special item hover effects */
.special-item-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    border-color: #0056b3;
    background-color: #e7f3ff;
}

/* Special item click animation */
.special-item-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Special item success pulse animation */
@keyframes specialItemPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.special-item-customizable.success-pulse {
    animation: specialItemPulse 0.3s ease-in-out;
}

/* Order item selection for special items (different from calculator) */
.order-item-card.selected-for-modifier {
    border: 2px solid #28a745 !important;
    background: rgba(40, 167, 69, 0.1) !important;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.3) !important;
}

/* Disabled special items when no regular items */
.special-item-customizable:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

.special-item-customizable:disabled:hover {
    transform: none;
    box-shadow: none;
    border-color: #6c757d;
    background-color: transparent;
}

/* Order items container improvements */
.order-items-container {
    scrollbar-width: thin;
    scrollbar-color: #007bff #f8f9fa;
}

.order-items-container::-webkit-scrollbar {
    width: 6px;
}

.order-items-container::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 3px;
}

.order-items-container::-webkit-scrollbar-thumb {
    background: #007bff;
    border-radius: 3px;
}

.order-items-container::-webkit-scrollbar-thumb:hover {
    background: #0056b3;
}

/* Order section height improvements */
.order-section {
    min-height: 500px;
}

.order-section .card-body {
    padding: 1rem;
}

/* Better spacing for order items */
.order-item-card {
    margin-bottom: 0.75rem !important;
    transition: all 0.2s ease;
}

.order-item-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

/* Order summary styling */
.order-summary {
    border-top: 2px solid #e9ecef;
    padding-top: 1rem;
    margin-top: 1rem;
    background: rgba(248, 249, 250, 0.5);
    border-radius: 8px;
    padding: 1rem;
}

/* Calculator mode button disabled state */
.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn:disabled:hover {
    opacity: 0.5;
    transform: none;
}

/* Order items styling for better readability */
.order-item {
    margin-bottom: 8px;
    padding: 10px 12px;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
    background: #fff;
    line-height: 1.4;
}

.order-item .fw-bold {
    font-size: 14px;
    margin-bottom: 4px;
}

.order-item .text-muted {
    font-size: 12px;
    line-height: 1.3;
}

.order-summary .btn {
    font-weight: 600;
    min-height: 42px;
    font-size: 14px;
}

.order-summary strong {
    font-size: 16px;
    color: #333;
}

.order-summary .d-flex {
    margin-bottom: 15px;
}

/* Responsive Calculator */
@media (max-width: 767.98px) {
    .calc-btn {
        min-height: 60px;
        font-size: 1.3rem;
        font-weight: 700;
    }
    
    .calc-btn[data-action="apply"] {
        min-height: 65px;
        font-size: 1.4rem;
    }
    
    .quick-price-btn {
        min-height: 45px;
        font-size: 16px;
        font-weight: 700;
    }
    
    .calculator-display input {
        font-size: 1.5rem;
        padding: 15px;
    }
    
    .calculator-modes .btn {
        min-height: 50px;
        font-size: 1.2rem;
    }
    
    #calculatorTitle {
        font-size: 1.2rem;
    }
    
    .pos-right-column {
        height: auto;
        min-height: auto;
        flex-direction: column;
    }
    
    .order-section {
        flex: none;
        min-height: 300px;
    }
    
    .calculator-section {
        flex: none;
        min-height: 250px;
        max-height: none;
    }
    
    .order-items-container {
        max-height: 250px;
    }
}

@media (min-width: 768px) and (max-width: 991.98px) {
    .pos-right-column {
        min-height: calc(100vh - 180px);
    }
    
    .order-section {
        flex: 1.2;
    }
    
    .calculator-section {
        flex: 1.8;
        min-height: 320px;
        max-height: 480px;
    }
    
    .order-items-container {
        min-height: 100px;
        max-height: none;
        padding: 6px 0;
        margin-bottom: 0;
    }
    
    .calculator-section .card-body {
        min-height: 280px;
    }
    
    .order-section .card-body {
        padding: 0.8rem;
        position: relative;
    }
    
    .order-summary {
        padding: 10px;
        position: sticky;
        bottom: 0;
        background: #ffffff;
    }
}

@media (min-width: 992px) {
    .pos-right-column {
        min-height: calc(100vh - 160px);
    }
    
    .order-section {
        flex: 1.3;
    }
    
    .calculator-section {
        flex: 1.7;
        min-height: 350px;
        max-height: 550px;
    }
    
    .order-items-container {
        min-height: 150px;
        max-height: none;
        padding: 8px 0;
        margin-bottom: 0;
    }
    
    .calculator-section .card-body {
        min-height: 320px;
    }
    
    .order-section .card-body {
        position: relative;
    }
    
    .order-summary {
        position: sticky;
        bottom: 0;
        background: #ffffff;
    }
}

@media (min-width: 1200px) {
    .pos-right-column {
        min-height: calc(100vh - 140px);
    }
    
    .order-section {
        flex: 1.4;
    }
    
    .calculator-section {
        flex: 1.6;
        min-height: 380px;
        max-height: 580px;
    }
    
    .order-items-container {
        min-height: 220px;
        max-height: 480px;
        padding: 10px 0;
    }
    
    .calculator-section .card-body {
        min-height: 340px;
    }
    
    .order-section .card-body {
        padding: 1.2rem;
    }
}
</style>
{% endblock %}

<!-- Removed duplicate scripts block to avoid Jinja TemplateAssertionError -->

{% block scripts %}
<script>
// Advanced POS Customization System
let isEditMode = false;
let draggedElement = null;
let touchTimeout = null;
let lastTapTime = 0;

// Handle existing order items for "Add Items" functionality
let isAddingToExistingOrder = false;
let originalOrderItemsLoaded = false;
{% if existing_order and request.args.get('add_items') == 'true' %}
isAddingToExistingOrder = true;
console.log('Loading existing order items for order #{{ existing_order.order_number }}');
{% endif %}

// Color palette for item customization
const colorPalette = [
    '#e8f4f8', '#e8f5e8', '#fff3cd', '#f8d7da', '#e2e3f0', 
    '#d1ecf1', '#f4f4f4', '#cff4fc', '#ffeaa7', '#fab1a0',
    '#fd79a8', '#fdcb6e', '#6c5ce7', '#a29bfe', '#74b9ff',
    '#00b894', '#00cec9', '#e17055', '#636e72', '#2d3436'
];

// Track current values to prevent unnecessary updates
let currentSizing = {
    widthPct: null,
    heightPx: null, 
    fontPx: null,
    showImages: null,
    nameScale: null
};

// Dynamic sizing utilities with name badge support
function applySizing(widthPct, heightPx, fontPx, showImages, nameScale) {
    // Check if values have actually changed to prevent unnecessary updates
    const hasChanged = (
        currentSizing.widthPct !== widthPct ||
        currentSizing.heightPx !== heightPx ||
        currentSizing.fontPx !== fontPx ||
        currentSizing.showImages !== showImages ||
        currentSizing.nameScale !== nameScale
    );
    
    // Always handle image toggle immediately
    if (typeof showImages === 'boolean') {
        const body = document.body;
        if (!showImages) {
            body.classList.add('no-images');
        } else {
            body.classList.remove('no-images');
        }
    }
    
    if (!hasChanged) {
        return; // No other changes needed
    }
    
    // Update tracking
    currentSizing = {widthPct, heightPx, fontPx, showImages, nameScale};
    
    const root = document.documentElement;
    root.style.setProperty('--pos-card-width', widthPct + '%');
    root.style.setProperty('--pos-card-min-height', heightPx + 'px');
    if (fontPx) root.style.setProperty('--pos-font-size', fontPx + 'px');
    if (nameScale) root.style.setProperty('--name-badge-size', (fontPx * nameScale) + 'px');
    
    // Apply sizing to actual POS items immediately with high priority
    // Only apply if elements exist to avoid unnecessary DOM queries
    const cols = document.querySelectorAll('.pos-item-col.dyn-width');
    const cards = document.querySelectorAll('.modern-item.dyn-height');
    
    if (cols.length > 0) {
        cols.forEach(col => {
            col.style.setProperty('flex', `0 0 ${widthPct}%`, 'important');
            col.style.setProperty('max-width', `${widthPct}%`, 'important');
        });
    }
    
    if (cards.length > 0) {
        cards.forEach(card => {
            card.style.setProperty('min-height', heightPx + 'px', 'important');
            const thumb = card.querySelector('.item-thumb');
            if (thumb) {
                thumb.style.setProperty('height', (heightPx * 0.56) + 'px', 'important');
            }
        });
    }
    
    // Apply font size to name badges
    if (nameScale && fontPx) {
        const badges = document.querySelectorAll('.transparent-name-badge');
        if (badges.length > 0) {
            badges.forEach(badge => {
                badge.style.setProperty('font-size', (fontPx * nameScale) + 'px', 'important');
            });
        }
    }
    
    // Update preview
    document.querySelectorAll('#previewGrid .preview-col').forEach(col => {
        col.style.flex = `0 0 ${widthPct}%`;
        col.style.maxWidth = `${widthPct}%`;
    });
    document.querySelectorAll('#previewGrid .modern-item').forEach(card => {
        card.style.minHeight = heightPx + 'px';
    });
}

// Toggle Edit Mode
function toggleEditMode() {
    isEditMode = !isEditMode;
    const lockBtn = document.getElementById('editLockBtn');
    const lockIcon = document.getElementById('editLockIcon');
    const editIndicator = document.getElementById('editModeIndicator');
    const body = document.body;
    
    if (isEditMode) {
        // Enable edit mode
        lockIcon.className = 'bi bi-unlock-fill';
        lockBtn.classList.remove('btn-outline-warning');
        lockBtn.classList.add('btn-warning');
        lockBtn.querySelector('span').textContent = 'Unlock';
        editIndicator.classList.remove('d-none');
        body.classList.add('edit-mode-active');
        
        // Enable drag and drop
        enableDragAndDrop();
        
        // Show color picker buttons
        document.querySelectorAll('.edit-mode-controls').forEach(control => {
            control.classList.remove('d-none');
        });
        
        // Disable item selection for cart
        document.querySelectorAll('.item-card').forEach(card => {
            card.style.pointerEvents = 'none';
        });
        
        // Enable customization interactions
        enableCustomizationInteractions();
        
    } else {
        // Disable edit mode
        lockIcon.className = 'bi bi-lock-fill';
        lockBtn.classList.remove('btn-warning');
        lockBtn.classList.add('btn-outline-warning');
        lockBtn.querySelector('span').textContent = 'Lock';
        editIndicator.classList.add('d-none');
        body.classList.remove('edit-mode-active');
        
        // Auto-save all color customizations when locking
        saveItemCustomizations();
        
        // Disable drag and drop
        disableDragAndDrop();
        
        // Hide color picker buttons
        document.querySelectorAll('.edit-mode-controls').forEach(control => {
            control.classList.add('d-none');
        });
        
        // Enable item selection for cart
        document.querySelectorAll('.item-card').forEach(card => {
            card.style.pointerEvents = 'auto';
        });
        
        // Save customizations
        saveItemCustomizations();
    }
}

// Enable drag and drop functionality
function enableDragAndDrop() {
    document.querySelectorAll('.draggable-item').forEach(item => {
        item.draggable = true;
        
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragend', handleDragEnd);
        
        // Touch events for mobile
        item.addEventListener('touchstart', handleTouchStart, {passive: false});
        item.addEventListener('touchmove', handleTouchMove, {passive: false});
        item.addEventListener('touchend', handleTouchEnd, {passive: false});
    });
}

// Disable drag and drop functionality
function disableDragAndDrop() {
    document.querySelectorAll('.draggable-item').forEach(item => {
        item.draggable = false;
        item.removeEventListener('dragstart', handleDragStart);
        item.removeEventListener('dragover', handleDragOver);
        item.removeEventListener('drop', handleDrop);
        item.removeEventListener('dragend', handleDragEnd);
        item.removeEventListener('touchstart', handleTouchStart);
        item.removeEventListener('touchmove', handleTouchMove);
        item.removeEventListener('touchend', handleTouchEnd);
    });
}

// Drag and drop event handlers
function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
}

function handleDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    this.classList.add('drag-over');
    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    
    if (draggedElement !== this) {
        // Swap elements
        const draggedParent = draggedElement.parentNode;
        const droppedParent = this.parentNode;
        
        const draggedNext = draggedElement.nextSibling;
        const droppedNext = this.nextSibling;
        
        draggedParent.insertBefore(this, draggedNext);
        droppedParent.insertBefore(draggedElement, droppedNext);
    }
    
    return false;
}

function handleDragEnd(e) {
    document.querySelectorAll('.draggable-item').forEach(item => {
        item.classList.remove('dragging', 'drag-over');
    });
    draggedElement = null;
}

// Touch events for mobile drag and drop
let touchStartPos = {x: 0, y: 0};
let touchElement = null;

function handleTouchStart(e) {
    if (!isEditMode) return;
    
    const touch = e.touches[0];
    touchStartPos = {x: touch.clientX, y: touch.clientY};
    touchElement = this;
    
    // Check for double tap (color change)
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTapTime;
    
    if (tapLength < 500 && tapLength > 0) {
        // Double tap detected - show color picker
        showColorPicker(this);
        e.preventDefault();
        return;
    }
    
    lastTapTime = currentTime;
}

function handleTouchMove(e) {
    if (!isEditMode || !touchElement) return;
    
    const touch = e.touches[0];
    const deltaX = Math.abs(touch.clientX - touchStartPos.x);
    const deltaY = Math.abs(touch.clientY - touchStartPos.y);
    
    // If moved significantly, start drag
    if (deltaX > 10 || deltaY > 10) {
        touchElement.classList.add('dragging');
        e.preventDefault();
    }
}

function handleTouchEnd(e) {
    if (!isEditMode) return;
    
    if (touchElement) {
        touchElement.classList.remove('dragging');
        
        // Find element under touch point
        const touch = e.changedTouches[0];
        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        const targetItem = elementBelow?.closest('.draggable-item');
        
        if (targetItem && targetItem !== touchElement) {
            // Perform swap
            const parent1 = touchElement.parentNode;
            const parent2 = targetItem.parentNode;
            const next1 = touchElement.nextSibling;
            const next2 = targetItem.nextSibling;
            
            parent1.insertBefore(targetItem, next1);
            parent2.insertBefore(touchElement, next2);
        }
        
        touchElement = null;
    }
}

// Enable customization interactions
function enableCustomizationInteractions() {
    // Color picker buttons (exclude special items)
    document.querySelectorAll('.color-picker-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const itemCard = this.closest('.item-card');
            // Only allow color picking for non-special items
            if (!itemCard.classList.contains('special-item-customizable')) {
                showColorPicker(itemCard);
            }
        });
    });
    
    // Double-click/tap for color change (exclude special items)
    document.querySelectorAll('.item-card').forEach(card => {
        card.addEventListener('dblclick', function() {
            if (isEditMode && !this.classList.contains('special-item-customizable')) {
                showColorPicker(this);
            }
        });
    });
}

// Show color picker modal
function showColorPicker(itemCard) {
    const currentColor = itemCard.dataset.customColor || '';
    
    // Create color picker modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Choose Color</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="color-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                        ${colorPalette.map(color => `
                            <button class="color-option" style="width: 40px; height: 40px; background: ${color}; border: 2px solid ${currentColor === color ? '#000' : '#ccc'}; border-radius: 8px; cursor: pointer;" data-color="${color}"></button>
                        `).join('')}
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary btn-sm" id="resetColor">Reset to Default</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    
    // Color selection handlers
    modal.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            const color = this.dataset.color;
            applyColorToItem(itemCard, color);
            bootstrapModal.hide();
        });
    });
    
    // Reset color handler
    modal.querySelector('#resetColor').addEventListener('click', function() {
        applyColorToItem(itemCard, '');
        bootstrapModal.hide();
    });
    
    // Clean up modal after hiding
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
    
    bootstrapModal.show();
}

// Apply color to item (only for non-special items)
function applyColorToItem(itemCard, color) {
    // Don't allow color changes for special items
    if (itemCard.classList.contains('special-item-customizable')) {
        return;
    }
    
    if (color) {
        // Apply custom color with !important to override CSS
        itemCard.style.setProperty('background', color, 'important');
        itemCard.style.setProperty('border-color', color, 'important');
        itemCard.style.setProperty('border-left', `4px solid ${color}`, 'important');
        itemCard.dataset.customColor = color;
    } else {
        // Reset to default
        itemCard.style.removeProperty('background');
        itemCard.style.removeProperty('border-color');
        itemCard.style.removeProperty('border-left');
        itemCard.dataset.customColor = '';
    }
    
    // Visual feedback removed - no more flashing message
}

// Show double-tap indicator
function showDoubleTabIndicator(element, text) {
    const indicator = document.createElement('div');
    indicator.className = 'double-tap-indicator';
    indicator.textContent = text;
    element.appendChild(indicator);
    
    setTimeout(() => {
        if (indicator.parentNode) {
            indicator.parentNode.removeChild(indicator);
        }
    }, 1000);
}

// Save item customizations to backend
function saveItemCustomizations() {
    const customizations = [];
    
    document.querySelectorAll('.item-card').forEach(card => {
        const itemId = card.dataset.itemId;
        const customColor = card.dataset.customColor;
        const order = Array.from(card.parentNode.children).indexOf(card.parentNode);
        
        if (customColor || order !== parseInt(card.dataset.itemOrder)) {
            customizations.push({
                item_id: itemId,
                custom_color: customColor || null,
                display_order: order
            });
        }
    });
    
    if (customizations.length > 0) {
        fetch('/pos/save_item_customizations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({customizations: customizations})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Customizations saved successfully');
            } else {
                console.error('Error saving customizations:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
}

function debounce(fn, delay) {
    let t; return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), delay); };
}

// Special Items Customization Functions
function applySpecialSizing(widthPct, heightPx, fontPx, spacingPx, sidebarWidth) {
    const root = document.documentElement;
    root.style.setProperty('--special-width-pct', widthPct);
    root.style.setProperty('--special-height-px', heightPx);
    root.style.setProperty('--special-font-px', fontPx);
    root.style.setProperty('--special-spacing-px', spacingPx);
    if (sidebarWidth !== undefined) {
        root.style.setProperty('--special-sidebar-width', sidebarWidth);
    }
}

// Load saved item customizations (colors) from backend
function loadSavedCustomizations() {
    // Fetch saved customizations from backend
    fetch('/pos/get_item_customizations')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.customizations) {
                data.customizations.forEach(customization => {
                    const itemCard = document.querySelector(`[data-item-id="${customization.item_id}"]`);
                    if (itemCard && customization.custom_color) {
                        applyColorToItem(itemCard, customization.custom_color);
                    }
                });
            }
        })
        .catch(error => {
            console.log('No saved customizations found or error loading:', error);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize current sizing values with template preferences to prevent initial flash
    currentSizing = {
        widthPct: {{ ui_prefs.card_width_pct }},
        heightPx: {{ ui_prefs.card_min_height_px }},
        fontPx: {{ ui_prefs.font_size_px }},
        showImages: {{ ui_prefs.show_images|lower }},
        nameScale: {{ ui_prefs.name_badge_scale }}
    };
    
    // Load saved item customizations (colors)
    loadSavedCustomizations();
    
    // Initialize edit mode toggle
    const editLockBtn = document.getElementById('editLockBtn');
    if (editLockBtn) {
        editLockBtn.addEventListener('click', toggleEditMode);
    }
    
    // Initialize customization modal
    const customizeBtn = document.getElementById('customizeSizeBtn');
    const widthSlider = document.getElementById('widthSlider');
    const heightSlider = document.getElementById('heightSlider');
    const fontSlider = document.getElementById('fontSlider');
    const nameScaleSlider = document.getElementById('nameScaleSlider');
    const showImagesSwitch = document.getElementById('showImagesSwitch');
    const widthValue = document.getElementById('widthValue');
    const heightValue = document.getElementById('heightValue');
    const fontValue = document.getElementById('fontValue');
    const nameScaleValue = document.getElementById('nameScaleValue');
    const customizeModalEl = document.getElementById('customizeSizeModal');
    const customizeModal = customizeModalEl ? new bootstrap.Modal(customizeModalEl) : null;

    // Load and apply saved preferences initially
    fetch('/pos/get_ui_prefs')
        .then(r => r.json())
        .then(d => {
            if (!d.success) return;
            const w = d.data.card_width_pct || 50;
            const h = d.data.card_min_height_px || 160;
            const f = d.data.font_size_px || 14;
            const si = typeof d.data.show_images === 'boolean' ? d.data.show_images : true;
            const ns = d.data.name_badge_scale || 1.0;
            applySizing(w, h, f, si, ns);
        })
        .catch(()=>{});

    if (customizeBtn && customizeModal) {
        customizeBtn.addEventListener('click', function() {
            fetch('/pos/get_ui_prefs')
                .then(r => r.json())
                .then(d => {
                    const w = (d.success && d.data.card_width_pct != null) ? d.data.card_width_pct : 50;
                    const h = (d.success && d.data.card_min_height_px != null) ? d.data.card_min_height_px : 160;
                    const f = (d.success && d.data.font_size_px != null) ? d.data.font_size_px : 14;
                    const si = (d.success && typeof d.data.show_images === 'boolean') ? d.data.show_images : true;
                    const ns = (d.success && d.data.name_badge_scale != null) ? d.data.name_badge_scale : 1.0;
                    widthSlider.value = w; widthValue.textContent = w + '%';
                    heightSlider.value = h; heightValue.textContent = h + 'px';
                    fontSlider.value = f; fontValue.textContent = f + 'px';
                    showImagesSwitch.checked = !!si;
                    if (nameScaleSlider) { nameScaleSlider.value = ns; nameScaleValue.textContent = ns.toFixed(2) + 'x'; }
                    // Sync preview to current
                    applySizing(w, h, f, si, ns);
                    customizeModal.show();
                })
                .catch(() => {
                    // defaults
                    widthSlider.value = 50; widthValue.textContent = '50%';
                    heightSlider.value = 160; heightValue.textContent = '160px';
                    fontSlider.value = 14; fontValue.textContent = '14px';
                    showImagesSwitch.checked = true;
                    if (nameScaleSlider) { nameScaleSlider.value = 1.0; nameScaleValue.textContent = '1.00x'; }
                    applySizing(50,160,14,true,1.0);
                    customizeModal.show();
                });
        });

        const saveDebounced = debounce((w,h,f,si,ns)=>{
            fetch('/pos/save_ui_prefs', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ card_width_pct: w, card_min_height_px: h, font_size_px: f, show_images: si, name_badge_scale: ns })
            }).catch(()=>{});
        }, 300);

        function onChange(){
            const w = parseInt(widthSlider.value, 10);
            const h = parseInt(heightSlider.value, 10);
            const f = parseInt(fontSlider.value, 10);
            const si = !!showImagesSwitch.checked;
            const ns = nameScaleSlider ? parseFloat(nameScaleSlider.value) : 1.0;
            widthValue.textContent = w + '%';
            heightValue.textContent = h + 'px';
            fontValue.textContent = f + 'px';
            if (nameScaleValue) nameScaleValue.textContent = ns.toFixed(2) + 'x';
            
            applySizing(w, h, f, si, ns);
            saveDebounced(w, h, f, si, ns);
        }

        widthSlider.addEventListener('input', onChange);
        heightSlider.addEventListener('input', onChange);
        fontSlider.addEventListener('input', onChange);
        if (nameScaleSlider) nameScaleSlider.addEventListener('input', onChange);
        showImagesSwitch.addEventListener('change', onChange);

        // Explicit Save button
        const saveBtn = document.getElementById('saveSizePrefsBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', function() {
                const w = parseInt(widthSlider.value, 10);
                const h = parseInt(heightSlider.value, 10);
                const f = parseInt(fontSlider.value, 10);
                const si = !!showImagesSwitch.checked;
                const ns = nameScaleSlider ? parseFloat(nameScaleSlider.value) : 1.0;
                fetch('/pos/save_ui_prefs', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ card_width_pct: w, card_min_height_px: h, font_size_px: f, show_images: si, name_badge_scale: ns })
                })
                .then(()=>{
                    applySizing(w, h, f, si, ns);
                    customizeModal.hide();
                })
                .catch(()=>{
                    // Keep modal open on error, but sizing already applied locally
                });
            });
        }

        // Reset to defaults
        const resetBtn = document.getElementById('resetSizePrefsBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                const w = 50, h = 160, f = 14, si = true, ns = 1.0;
                widthSlider.value = w; widthValue.textContent = w + '%';
                heightSlider.value = h; heightValue.textContent = h + 'px';
                fontSlider.value = f; fontValue.textContent = f + 'px';
                showImagesSwitch.checked = si;
                if (nameScaleSlider) { nameScaleSlider.value = ns; nameScaleValue.textContent = ns.toFixed(2) + 'x'; }
                applySizing(w, h, f, si, ns);
                fetch('/pos/save_ui_prefs', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ card_width_pct: w, card_min_height_px: h, font_size_px: f, show_images: si, name_badge_scale: ns })
                }).catch(()=>{});
            });
        }
    }

    // Initialize Special Items Customization
    const customizeSpecialBtn = document.getElementById('customizeSpecialBtn');
    const customizeSpecialBtnMobile = document.getElementById('customizeSpecialBtnMobile');
    const specialWidthSlider = document.getElementById('specialWidthSlider');
    const specialHeightSlider = document.getElementById('specialHeightSlider');
    const specialFontSlider = document.getElementById('specialFontSlider');
    const specialSpacingSlider = document.getElementById('specialSpacingSlider');
    const specialSidebarWidthSlider = document.getElementById('specialSidebarWidthSlider');
    const specialWidthValue = document.getElementById('specialWidthValue');
    const specialHeightValue = document.getElementById('specialHeightValue');
    const specialFontValue = document.getElementById('specialFontValue');
    const specialSpacingValue = document.getElementById('specialSpacingValue');
    const specialSidebarWidthValue = document.getElementById('specialSidebarWidthValue');
    const customizeSpecialModalEl = document.getElementById('customizeSpecialModal');
    const customizeSpecialModal = customizeSpecialModalEl ? new bootstrap.Modal(customizeSpecialModalEl) : null;

    // Load and apply saved special items preferences initially
    fetch('/pos/get_special_ui_prefs')
        .then(r => r.json())
        .then(d => {
            if (!d.success) return;
            const w = d.data.special_width_pct || 100;
            const h = d.data.special_height_px || 40;
            const f = d.data.special_font_px || 11;
            const s = d.data.special_spacing_px || 8;
            const sw = d.data.special_sidebar_width || 100;
            applySpecialSizing(w, h, f, s, sw);
        })
        .catch(()=>{});

    if ((customizeSpecialBtn || customizeSpecialBtnMobile) && customizeSpecialModal) {
        const openSpecialModal = function() {
            fetch('/pos/get_special_ui_prefs')
                .then(r => r.json())
                .then(d => {
                    const w = (d.success && d.data.special_width_pct != null) ? d.data.special_width_pct : 100;
                    const h = (d.success && d.data.special_height_px != null) ? d.data.special_height_px : 40;
                    const f = (d.success && d.data.special_font_px != null) ? d.data.special_font_px : 11;
                    const s = (d.success && d.data.special_spacing_px != null) ? d.data.special_spacing_px : 8;
                    const sw = (d.success && d.data.special_sidebar_width != null) ? d.data.special_sidebar_width : 100;
                    specialWidthSlider.value = w; specialWidthValue.textContent = w + '%';
                    specialHeightSlider.value = h; specialHeightValue.textContent = h + 'px';
                    specialFontSlider.value = f; specialFontValue.textContent = f + 'px';
                    specialSpacingSlider.value = s; specialSpacingValue.textContent = s + 'px';
                    specialSidebarWidthSlider.value = sw; specialSidebarWidthValue.textContent = sw + '%';
                    applySpecialSizing(w, h, f, s, sw);
                    customizeSpecialModal.show();
                })
                .catch(() => {
                    // defaults
                    specialWidthSlider.value = 100; specialWidthValue.textContent = '100%';
                    specialHeightSlider.value = 40; specialHeightValue.textContent = '40px';
                    specialFontSlider.value = 11; specialFontValue.textContent = '11px';
                    specialSpacingSlider.value = 8; specialSpacingValue.textContent = '8px';
                    specialSidebarWidthSlider.value = 100; specialSidebarWidthValue.textContent = '100%';
                    applySpecialSizing(100, 40, 11, 8, 100);
                    customizeSpecialModal.show();
                });
        };
        
        // Add event listeners for both desktop and mobile buttons
        if (customizeSpecialBtn) {
            customizeSpecialBtn.addEventListener('click', openSpecialModal);
        }
        if (customizeSpecialBtnMobile) {
            customizeSpecialBtnMobile.addEventListener('click', openSpecialModal);
        }

        const saveSpecialDebounced = debounce((w,h,f,s,sw)=>{
            fetch('/pos/save_special_ui_prefs', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ special_width_pct: w, special_height_px: h, special_font_px: f, special_spacing_px: s, special_sidebar_width: sw })
            }).catch(()=>{});
        }, 300);

        function onSpecialChange(){
            const w = parseInt(specialWidthSlider.value, 10);
            const h = parseInt(specialHeightSlider.value, 10);
            const f = parseInt(specialFontSlider.value, 10);
            const s = parseInt(specialSpacingSlider.value, 10);
            const sw = parseInt(specialSidebarWidthSlider.value, 10);
            specialWidthValue.textContent = w + '%';
            specialHeightValue.textContent = h + 'px';
            specialFontValue.textContent = f + 'px';
            specialSpacingValue.textContent = s + 'px';
            specialSidebarWidthValue.textContent = sw + '%';
            applySpecialSizing(w, h, f, s, sw);
            saveSpecialDebounced(w, h, f, s, sw);
        }

        specialWidthSlider.addEventListener('input', onSpecialChange);
        specialHeightSlider.addEventListener('input', onSpecialChange);
        specialFontSlider.addEventListener('input', onSpecialChange);
        specialSpacingSlider.addEventListener('input', onSpecialChange);
        specialSidebarWidthSlider.addEventListener('input', onSpecialChange);

        // Save button
        const saveSpecialBtn = document.getElementById('saveSpecialPrefsBtn');
        if (saveSpecialBtn) {
            saveSpecialBtn.addEventListener('click', function() {
                const w = parseInt(specialWidthSlider.value, 10);
                const h = parseInt(specialHeightSlider.value, 10);
                const f = parseInt(specialFontSlider.value, 10);
                const s = parseInt(specialSpacingSlider.value, 10);
                const sw = parseInt(specialSidebarWidthSlider.value, 10);
                fetch('/pos/save_special_ui_prefs', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ special_width_pct: w, special_height_px: h, special_font_px: f, special_spacing_px: s, special_sidebar_width: sw })
                })
                .then(()=>{
                    applySpecialSizing(w, h, f, s, sw);
                    customizeSpecialModal.hide();
                })
                .catch(()=>{});
            });
        }

        // Reset to defaults
        const resetSpecialBtn = document.getElementById('resetSpecialPrefsBtn');
        if (resetSpecialBtn) {
            resetSpecialBtn.addEventListener('click', function() {
                const w = 100, h = 40, f = 11, s = 8, sw = 100;
                specialWidthSlider.value = w; specialWidthValue.textContent = w + '%';
                specialHeightSlider.value = h; specialHeightValue.textContent = h + 'px';
                specialFontSlider.value = f; specialFontValue.textContent = f + 'px';
                specialSpacingSlider.value = s; specialSpacingValue.textContent = s + 'px';
                specialSidebarWidthSlider.value = sw; specialSidebarWidthValue.textContent = sw + '%';
                applySpecialSizing(w, h, f, s, sw);
                fetch('/pos/save_special_ui_prefs', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ special_width_pct: w, special_height_px: h, special_font_px: f, special_spacing_px: s, special_sidebar_width: sw })
                }).catch(()=>{});
            });
        }
    }
});

// Helper function to compare modifiers between items
function modifiersAreEqual(modifiers1, modifiers2) {
    if (!modifiers1 && !modifiers2) return true;
    if (!modifiers1 || !modifiers2) return false;
    if (modifiers1.length !== modifiers2.length) return false;
    
    // Sort both arrays by id for comparison
    const sorted1 = [...modifiers1].sort((a, b) => a.id.localeCompare(b.id));
    const sorted2 = [...modifiers2].sort((a, b) => a.id.localeCompare(b.id));
    
    for (let i = 0; i < sorted1.length; i++) {
        if (sorted1[i].id !== sorted2[i].id || sorted1[i].quantity !== sorted2[i].quantity) {
            return false;
        }
    }
    return true;
}

// Load delivery companies dynamically
function loadDeliveryCompanies() {
    fetch('/pos/get_delivery_companies')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderDeliveryCompanies(data.companies);
            } else {
                console.error('Error loading delivery companies:', data.message);
                renderDeliveryCompaniesError();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            renderDeliveryCompaniesError();
        });
}

function renderDeliveryCompanies(companies) {
    const container = document.getElementById('deliveryCompaniesContainer');
    
    if (companies.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-3">
                <i class="bi bi-truck text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-2 mb-0">No delivery companies available</p>
                <small class="text-muted">Please contact admin to add delivery companies</small>
            </div>
        `;
        return;
    }
    
    let html = '';
    companies.forEach(company => {
        const colors = ['text-danger', 'text-primary', 'text-warning', 'text-success', 'text-info', 'text-secondary'];
        const colorClass = colors[Math.floor(Math.random() * colors.length)];
        
        html += `
            <div class="col-md-3 col-6">
                <div class="delivery-option" data-company="${company.value}" data-company-id="${company.id}">
                    <div class="card h-100 border-2 delivery-card">
                        <div class="card-body text-center p-3">
                            <i class="${company.icon} display-6 ${colorClass} mb-2"></i>
                            <h6 class="card-title mb-0">${company.name}</h6>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Reattach event listeners for delivery options
    attachDeliveryOptionListeners();
}

function renderDeliveryCompaniesError() {
    const container = document.getElementById('deliveryCompaniesContainer');
    container.innerHTML = `
        <div class="col-12 text-center py-3">
            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
            <p class="text-muted mt-2 mb-0">Error loading delivery companies</p>
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadDeliveryCompanies()">
                <i class="bi bi-arrow-clockwise"></i> Retry
            </button>
        </div>
    `;
}

function attachDeliveryOptionListeners() {
    document.querySelectorAll('.delivery-option').forEach(option => {
        option.addEventListener('click', function() {
            // Remove selected class from all options
            document.querySelectorAll('.delivery-option').forEach(opt => opt.classList.remove('selected'));
            
            // Add selected class to clicked option
            this.classList.add('selected');
            selectedDeliveryCompany = this.dataset.company;
            selectedDeliveryCompanyId = parseInt(this.dataset.companyId);
            
            // Update display
            const companyName = this.querySelector('.card-title').textContent;
            document.getElementById('selectedDeliveryCompany').textContent = companyName;
            
            // Update confirm button state
            updateConfirmButton();
        });
    });
}

// Initialize all modal functionality when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize table selection
    initializeTableSelection();
    
    // Initialize service type selection
    initializeServiceTypeSelection();
    
    // Initialize cashier selection for waiters
    initializeCashierSelection();
    
    // Initialize delivery company loading
    loadDeliveryCompanies();
    
    // Note: Item colors are now preloaded in template to prevent flashing
    // loadItemCustomizations() is only called in edit mode
    
    // Ensure orderItems is properly initialized as an array
    if (!window.orderItems || !Array.isArray(window.orderItems)) {
        window.orderItems = [];
    }
    
    // For "Add Items" functionality, start with clean cart
    {% if existing_order and request.args.get('add_items') == 'true' %}
    if (isAddingToExistingOrder && !originalOrderItemsLoaded) {
        // Start with clean cart - waiter will add only NEW items
        window.orderItems = [];
        console.log('Starting with clean cart for adding items to existing order #{{ existing_order.order_number }}');
        updateOrderDisplay();
        // Mark as loaded to prevent re-initialization
        originalOrderItemsLoaded = true;
    }
    {% endif %}
    
    // Track selected order item for modifier attachment
    window.selectedOrderItemIndex = null;
    
    // Track last selected regular item for automatic special item attachment
    window.lastSelectedRegularItemIndex = null;
    window.selectedOrderItemIndex = null;

    // Add item to order (regular menu items)
    document.querySelectorAll('.item-card').forEach(card => {
        card.addEventListener('click', function() {
            // Skip if in edit mode to prevent accidental item addition during customization
            if (window.isEditMode) {
                return;
            }
            
            const itemId = this.getAttribute('data-item-id');
            const itemName = this.getAttribute('data-item-name');
            const itemPrice = parseFloat(this.getAttribute('data-item-price'));
            const itemType = this.getAttribute('data-item-type');
            
            // Check if this is Falafel Hab - show custom price modal
            if (itemName === 'Falafel Hab') {
                showFalafelHabPriceModal();
                return;
            }
            
            // Check if this is special order - show custom price modal
            if (itemName === 'special order') {
                showSpecialOrderPriceModal();
                return;
            }
            
            // Check if this is a special item from the category menu
            const originalCategory = this.getAttribute('data-original-category');
            const isSpecialItemFromCategory = originalCategory && document.querySelector(`[data-category-id="${originalCategory}"]`)?.textContent?.includes('طلبات خاصة');
            
            // Handle special items from category menu - they should act as modifiers
            if (isSpecialItemFromCategory || itemType === 'special') {
                addSpecialItemAsModifier(itemId, itemName, itemPrice);
                return;
            }
            
            // Handle regular menu items
            // Check if item already in order with IDENTICAL modifiers
            let existingItem = window.orderItems.find(item => 
                String(item.id) === String(itemId) && 
                modifiersAreEqual(item.modifiers, []) // New items start with no modifiers
            );
            
            if (existingItem) {
                existingItem.quantity += 1;
                existingItem.total = existingItem.quantity * itemPrice;
                
                // Track this as the last selected regular item for automatic special item attachment
                const existingItemIndex = window.orderItems.indexOf(existingItem);
                if (existingItemIndex >= 0) {
                    window.lastSelectedRegularItemIndex = existingItemIndex;
                    // Auto-select this item for special item attachment
                    window.selectedOrderItemIndex = existingItemIndex;
                    
                    // Auto-select for calculator (last added item)
                    autoSelectLastItemForCalculator(existingItemIndex);
                }
            } else {
                // Add regular menu item
                window.orderItems.push({
                    id: String(itemId),
                    name: itemName,
                    price: itemPrice,
                    quantity: 1,
                    total: itemPrice,
                    type: 'regular',
                    modifiers: [] // Array to hold special item modifiers
                });
                
                // Track this as the last selected regular item for automatic special item attachment
                window.lastSelectedRegularItemIndex = window.orderItems.length - 1;
                // Auto-select this item for special item attachment
                window.selectedOrderItemIndex = window.orderItems.length - 1;
                
                // Auto-select for calculator (last added item)
                autoSelectLastItemForCalculator(window.orderItems.length - 1);
            }
            
            updateOrderDisplay();
        });
    });

    // Table selection functionality
    window.selectedTableId = null;
    window.selectedTableNumber = null;
    
    // Handle pre-selected table from table management
    {% if selected_table_id %}
        window.selectedTableId = {{ selected_table_id }};
        
        // Store table information directly (no need to find buttons in main interface)
        // Find the table number from the tables data passed to template
        {% for table in tables %}
            {% if table.id == selected_table_id %}
                window.selectedTableNumber = '{{ table.table_number }}';
                console.log('Pre-selected table from template data:', window.selectedTableNumber);
            {% endif %}
        {% endfor %}
        
        // If we couldn't get it from template, we'll get it when the modal opens
        if (!window.selectedTableNumber) {
            console.log('Table number will be determined when modal opens');
        }
        
        // Also set the service type to on_table automatically
        selectedServiceType = 'on_table';
        
        // Mark this as a pre-selected table scenario
        window.isPreSelectedTable = true;
    {% else %}
        window.isPreSelectedTable = false;
    {% endif %}
    
    // Store return URL for redirection after order completion
    {% if return_to %}
        window.returnTo = '{{ return_to }}';
    {% else %}
        window.returnTo = null;
    {% endif %}
    
    document.querySelectorAll('.table-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tableId = this.getAttribute('data-table-id');
            const tableNumber = this.getAttribute('data-table-number');
            
            // Toggle selection - if already selected, deselect it
            if (this.classList.contains('selected')) {
                // Deselect this table
                this.classList.remove('selected');
                window.selectedTableId = null;
                window.selectedTableNumber = null;
            } else {
                // Remove selection from all buttons
                document.querySelectorAll('.table-btn').forEach(b => b.classList.remove('selected'));
                
                // Select this button
                this.classList.add('selected');
                window.selectedTableId = tableId;
                window.selectedTableNumber = tableNumber;
            }
            
            // Update complete order button state
            updateCompleteOrderButton();
        });
    });
    
    // Function to clear table selection
    function clearTableSelection() {
        document.querySelectorAll('.table-btn').forEach(btn => btn.classList.remove('selected'));
        window.selectedTableId = null;
        window.selectedTableNumber = null;
        updateCompleteOrderButton();
    }

    // Recent orders button functionality
    document.getElementById('recentOrdersBtn').addEventListener('click', function() {
        // Initialize order items array
        window.orderItems = [];
        
        // Track selected order item for modifier attachment
        window.selectedOrderItemIndex = null;
        
        // Track last selected regular item for automatic special item attachment
        window.lastSelectedRegularItemIndex = null;
        
        // Store original button content for special items
        const originalButtonContent = new Map();
        document.querySelectorAll('.special-item-customizable').forEach(btn => {
            originalButtonContent.set(btn.getAttribute('data-item-id'), btn.innerHTML);
        });

        loadRecentOrders();
    });


    // Add special item to order
    document.querySelectorAll('.special-item-customizable').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            const itemName = this.getAttribute('data-item-name');
            const itemPrice = parseFloat(this.getAttribute('data-item-price'));
            
            addSpecialItemAsModifier(itemId, itemName, itemPrice);
        });
    });

    // Clear order
    document.getElementById('clearOrderBtn').addEventListener('click', function() {
        window.orderItems = [];
        
        // Reset selection indices
        window.selectedOrderItemIndex = null;
        window.lastSelectedRegularItemIndex = null;
        
        // Clear table selection
        clearTableSelection();
        
        updateOrderDisplay();
    });
});

// Clear order (duplicate handler - keeping for safety)
document.getElementById('clearOrderBtn').addEventListener('click', function() {
    window.orderItems = [];
    
    // Reset selection indices
    window.selectedOrderItemIndex = null;
    window.lastSelectedRegularItemIndex = null;
    
    // Clear table selection
    clearTableSelection();
    
    updateOrderDisplay();
});

// Complete order - Show modal
document.getElementById('completeOrderBtn').addEventListener('click', function() {
    if (window.orderItems.length === 0) return;
    
    // Calculate total
    const total = window.orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    document.getElementById('modalOrderTotal').textContent = total.toFixed(2) + ' QAR';
    
    // Reset modal selections (but preserve pre-selected table)
    document.querySelectorAll('.service-option').forEach(option => option.classList.remove('selected'));
    document.querySelectorAll('.delivery-option').forEach(option => option.classList.remove('selected'));
    document.querySelectorAll('.cashier-option').forEach(option => option.classList.remove('selected'));
    document.querySelectorAll('.table-btn-modal').forEach(btn => btn.classList.remove('selected'));
    document.getElementById('deliveryCompanySection').style.display = 'none';
    document.getElementById('deliveryCompanyRow').style.display = 'none';
    document.getElementById('tableSelectionSection').style.display = 'none';
    document.getElementById('selectedServiceType').textContent = 'Not Selected';
    document.getElementById('selectedDeliveryCompany').textContent = 'Not Selected';
    const selectedCashierElement = document.getElementById('selectedCashier');
    if (selectedCashierElement) {
        selectedCashierElement.textContent = 'Not Selected';
    }
    document.getElementById('confirmOrderBtn').disabled = true;
    
    // Only reset table selection if not pre-selected from table management
    if (!window.isPreSelectedTable) {
        window.selectedTableId = null;
        window.selectedTableNumber = null;
    }
    
    // Load delivery companies dynamically
    loadDeliveryCompanies();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('orderCompletionModal'));
    modal.show();
    
    // If we have a pre-selected table, completely customize the modal for direct confirmation
    if (window.isPreSelectedTable && window.selectedTableId) {
        setTimeout(() => {
            // If we don't have table number yet, try to get it from modal table buttons
            if (!window.selectedTableNumber) {
                const modalTableBtn = document.querySelector(`.table-btn-modal[data-table-id="${window.selectedTableId}"]`);
                if (modalTableBtn) {
                    window.selectedTableNumber = modalTableBtn.dataset.tableNumber;
                    console.log('Got table number from modal:', window.selectedTableNumber);
                } else {
                    console.error('Could not find table number for ID:', window.selectedTableId);
                    window.selectedTableNumber = window.selectedTableId; // Fallback to ID
                }
            }
            
            // Set service type silently
            selectedServiceType = 'on_table';
            
            // Hide the service type selection section completely
            const serviceTypeSection = document.getElementById('serviceTypeSection');
            if (serviceTypeSection) {
                serviceTypeSection.style.display = 'none';
            }
            
            // Hide delivery company section
            document.getElementById('deliveryCompanySection').style.display = 'none';
            document.getElementById('deliveryCompanyRow').style.display = 'none';
            
            // Show only the pre-selected table confirmation
            const tableSection = document.getElementById('tableSelectionSection');
            if (tableSection) {
                tableSection.style.display = 'block';
                tableSection.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-success d-flex align-items-center mb-4">
                            <i class="bi bi-table text-success me-3" style="font-size: 2.5rem;"></i>
                            <div class="flex-grow-1">
                                <h4 class="mb-1">Table ${window.selectedTableNumber}</h4>
                                <p class="mb-0 text-muted">Order will be sent to cashier for this table</p>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <p class="text-muted mb-3">Ready to send order to cashier</p>
                        </div>
                    </div>
                `;
            }
            
            // Enable confirm button immediately
            const confirmBtn = document.getElementById('confirmOrderBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('btn-secondary');
                confirmBtn.classList.add('btn-success');
                confirmBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Send to Cashier';
            }
            
            console.log('Pre-selected table modal configured for direct confirmation');
        }, 100);
    }
    
    // Update confirm button state when modal opens
    updateConfirmButton();
});

// Function to add special item as modifier to a regular item
function addSpecialItemAsModifier(itemId, itemName, itemPrice) {
    // Check if there are any regular items in the order
    if (window.orderItems.length === 0) {
        showSpecialItemWarning('Please add a menu item first before adding special requests.');
        return;
    }
    
    let targetItem = null;
    
    // Priority 1: If an order item is selected, use that
    if (window.selectedOrderItemIndex !== null && 
        window.selectedOrderItemIndex >= 0 && 
        window.selectedOrderItemIndex < window.orderItems.length) {
        targetItem = window.orderItems[window.selectedOrderItemIndex];
    } 
    // Priority 2: Use the last selected regular item
    else if (window.lastSelectedRegularItemIndex !== null && 
             window.lastSelectedRegularItemIndex >= 0 && 
             window.lastSelectedRegularItemIndex < window.orderItems.length) {
        targetItem = window.orderItems[window.lastSelectedRegularItemIndex];
    } 
    // Priority 3: Find the last added regular item (most recent)
    else {
        for (let i = window.orderItems.length - 1; i >= 0; i--) {
            if (window.orderItems[i].type === 'regular') {
                targetItem = window.orderItems[i];
                window.lastSelectedRegularItemIndex = i;
                break;
            }
        }
    }
    
    if (!targetItem) {
        showSpecialItemWarning('Please add a menu item first before adding special requests.');
        return;
    }
    
    // Ensure modifiers array exists
    if (!targetItem.modifiers) {
        targetItem.modifiers = [];
    }
    
    // Check if this modifier already exists for this item
    const existingModifier = targetItem.modifiers.find(mod => mod.id === String(itemId));
    if (existingModifier) {
        // Increase modifier quantity
        existingModifier.quantity += 1;
        console.log(`Increased modifier quantity for ${itemName} to ${existingModifier.quantity}`);
    } else {
        // Add new modifier to the target item
        targetItem.modifiers.push({
            id: String(itemId),
            name: itemName,
            quantity: 1
        });
        console.log(`Added modifier ${itemName} to ${targetItem.name}`);
    }
    
    // Visual feedback
    showSpecialItemSuccess(`Added "${itemName}" to "${targetItem.name}"`);
    
    // Add pulse animation to all special item buttons briefly
    document.querySelectorAll('.special-item-customizable').forEach(btn => {
        if (btn.getAttribute('data-item-id') === String(itemId)) {
            btn.classList.add('success-pulse');
            setTimeout(() => {
                btn.classList.remove('success-pulse');
            }, 300);
        }
    });
    
    console.log('Current order items:', window.orderItems);
    updateOrderDisplay();
}

// Function to show special item warning
function showSpecialItemWarning(message) {
    // Create or update warning element
    let warningEl = document.getElementById('special-item-warning');
    if (!warningEl) {
        warningEl = document.createElement('div');
        warningEl.id = 'special-item-warning';
        warningEl.className = 'alert alert-warning alert-dismissible fade show position-fixed';
        warningEl.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        document.body.appendChild(warningEl);
    }
    
    warningEl.innerHTML = `
        <i class="bi bi-exclamation-triangle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        if (warningEl && warningEl.parentNode) {
            warningEl.remove();
        }
    }, 3000);
}

// Function to show special item success message
function showSpecialItemSuccess(message) {
    // Create or update success element
    let successEl = document.getElementById('special-item-success');
    if (!successEl) {
        successEl = document.createElement('div');
        successEl.id = 'special-item-success';
        successEl.className = 'alert alert-success alert-dismissible fade show position-fixed';
        successEl.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        document.body.appendChild(successEl);
    }
    
    successEl.innerHTML = `
        <i class="bi bi-check-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Auto-hide after 2 seconds
    setTimeout(() => {
        if (successEl && successEl.parentNode) {
            successEl.remove();
        }
    }, 2000);
}

// Update order display
function updateOrderDisplay() {
    // Ensure orderItems is properly initialized as an array
    if (!window.orderItems || !Array.isArray(window.orderItems)) {
        window.orderItems = [];
    }
    
    const orderItemsContainer = document.getElementById('orderItems');
    const orderTotalElement = document.getElementById('orderTotal');
    const completeOrderBtn = document.getElementById('completeOrderBtn');
    
    if (window.orderItems.length === 0) {
        orderItemsContainer.innerHTML = '<p class="text-muted text-center">No items added yet</p>';
        orderTotalElement.textContent = '0.00 QAR';
        completeOrderBtn.disabled = true;
        return;
    }
    
    let html = '';
    let total = 0;
    
    window.orderItems.forEach((item, index) => {
        const itemClass = 'order-item regular-item';
        const priceDisplay = `${item.total.toFixed(2)} QAR`;
        const quantityDisplay = `${item.quantity} x `;
        const unitPriceDisplay = `${item.price.toFixed(2)} QAR`;
        
        // Build modifiers display
        let modifiersHtml = '';
        if (item.modifiers && item.modifiers.length > 0) {
            item.modifiers.forEach((modifier, modifierIndex) => {
                const modifierQuantity = modifier.quantity > 1 ? `${modifier.quantity}x ` : '';
                modifiersHtml += `
                    <div class="modifier-item text-muted small ms-3 d-flex justify-content-between align-items-center" style="margin-bottom: 2px;">
                        <span>+ ${modifierQuantity}${modifier.name}</span>
                        <button class="btn btn-sm btn-outline-danger remove-modifier" 
                                data-item-index="${index}" 
                                data-modifier-index="${modifierIndex}"
                                style="padding: 1px 4px; font-size: 10px; line-height: 1;"
                                onclick="event.stopPropagation();"
                                title="Remove modifier">
                            <i class="bi bi-x" style="font-size: 10px;"></i>
                        </button>
                    </div>
                `;
            });
        }
        
        // Check if this item is selected for modifier attachment
        const isSelected = window.selectedOrderItemIndex === index;
        const selectedClass = isSelected ? 'selected-for-modifier' : '';
        const selectedStyle = isSelected ? 'border: 2px solid #007bff; background-color: #f8f9ff;' : '';
        
        html += `
            <div class="${itemClass} mb-3 order-item-card ${selectedClass} clickable-order-item" 
                 style="border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; cursor: pointer; ${selectedStyle}" 
                 data-item-index="${index}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="item-info flex-grow-1">
                        <div class="item-name fw-bold">${item.name}</div>
                        <div class="item-details text-muted small">${quantityDisplay}${unitPriceDisplay}</div>
                        ${modifiersHtml}
                        ${isSelected ? '<small class="text-primary fw-bold"><i class="bi bi-arrow-left"></i> Selected for special items</small>' : ''}
                    </div>
                    <div class="d-flex align-items-center item-actions">
                        <span class="item-price me-2 fw-bold">${priceDisplay}</span>
                        <button class="btn btn-sm btn-outline-primary me-1 calculator-select-btn" data-item-index="${index}" onclick="event.stopPropagation();" title="Select for calculator">
                            <i class="bi bi-calculator"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger remove-item" data-item-index="${index}" onclick="event.stopPropagation();">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        total += item.total;
    });
    
    orderItemsContainer.innerHTML = html;
    orderTotalElement.textContent = total.toFixed(2) + ' QAR';
    updateCompleteOrderButton();
    
    // Add event listeners to remove buttons
    document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function() {
            const itemIndex = parseInt(this.getAttribute('data-item-index'));
            
            // Remove item by index
            if (itemIndex >= 0 && itemIndex < window.orderItems.length) {
                // Clear selection if removing selected item
                if (window.selectedOrderItemIndex === itemIndex) {
                    window.selectedOrderItemIndex = null;
                } else if (window.selectedOrderItemIndex > itemIndex) {
                    // Adjust selection index if removing item before selected item
                    window.selectedOrderItemIndex--;
                }
                
                window.orderItems.splice(itemIndex, 1);
                updateOrderDisplay();
            }
        });
    });
    
    // Add event listeners to order items for selection
    document.querySelectorAll('.clickable-order-item').forEach(item => {
        item.addEventListener('click', function() {
            const itemIndex = parseInt(this.getAttribute('data-item-index'));
            
            // Toggle selection
            if (window.selectedOrderItemIndex === itemIndex) {
                window.selectedOrderItemIndex = null; // Deselect if clicking same item
            } else {
                window.selectedOrderItemIndex = itemIndex; // Select this item
            }
            
            updateOrderDisplay(); // Refresh to show selection
        });
    });
    
    // Add event listeners to remove modifier buttons
    document.querySelectorAll('.remove-modifier').forEach(button => {
        button.addEventListener('click', function() {
            const itemIndex = parseInt(this.getAttribute('data-item-index'));
            const modifierIndex = parseInt(this.getAttribute('data-modifier-index'));
            
            // Remove modifier from item
            if (itemIndex >= 0 && itemIndex < window.orderItems.length) {
                const item = window.orderItems[itemIndex];
                if (item.modifiers && modifierIndex >= 0 && modifierIndex < item.modifiers.length) {
                    const modifier = item.modifiers[modifierIndex];
                    
                    if (modifier.quantity > 1) {
                        // Reduce quantity if more than 1
                        modifier.quantity -= 1;
                        console.log(`Reduced modifier quantity for ${modifier.name} to ${modifier.quantity}`);
                    } else {
                        // Remove modifier completely if quantity is 1
                        item.modifiers.splice(modifierIndex, 1);
                        console.log(`Removed modifier ${modifier.name} from ${item.name}`);
                    }
                    
                    updateOrderDisplay();
                }
            }
        });
    });
    
    // Add event listeners to calculator select buttons
    document.querySelectorAll('.calculator-select-btn').forEach(button => {
        button.addEventListener('click', function() {
            const itemIndex = parseInt(this.getAttribute('data-item-index'));
            const orderItemElement = this.closest('.order-item-card');
            
            if (orderItemElement) {
                selectOrderItemForCalculator(orderItemElement);
            }
        });
    });
}

// Update complete order button state
function updateCompleteOrderButton() {
    const completeOrderBtn = document.getElementById('completeOrderBtn');
    const hasItems = window.orderItems && window.orderItems.length > 0;
    
    if (hasItems) {
        completeOrderBtn.disabled = false;
        completeOrderBtn.classList.remove('btn-secondary');
        completeOrderBtn.classList.add('btn-success');
    } else {
        completeOrderBtn.disabled = true;
        completeOrderBtn.classList.remove('btn-success');
        completeOrderBtn.classList.add('btn-secondary');
    }
}

// Print invoice function
function printInvoice(orderId) {
    fetch('/pos/get_order_details/' + orderId)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Create invoice HTML
                let itemsHtml = '';
                data.order.items.forEach(item => {
                    // Build modifiers display
                    let modifiersHtml = '';
                    if (item.special_requests && item.special_requests.trim()) {
                        modifiersHtml = `<br><small class="text-muted">+ ${item.special_requests}</small>`;
                    }
                    
                    itemsHtml += `
                        <tr>
                            <td>${item.menu_item_name}${modifiersHtml}</td>
                            <td>${item.quantity}</td>
                            <td>${parseFloat(item.unit_price).toFixed(2)} QAR</td>
                            <td>${parseFloat(item.total_price).toFixed(2)} QAR</td>
                        </tr>
                    `;
                });
                
                const invoiceHtml = `
                    <div class="container invoice-container">
                        <div class="invoice-header text-center mb-4">
                            <h3>Restaurant POS</h3>
                            <h4>Invoice</h4>
                            <p>Order #${data.order.order_number}</p>
                            <p>${new Date(data.order.created_at).toLocaleString()}</p>
                        </div>
                        
                        <div class="mb-3">
                            <p><strong>Cashier:</strong> ${data.order.cashier_name || 'N/A'}</p>
                            <p><strong>Table:</strong> ${data.order.table_number || 'N/A'}</p>
                        </div>
                        
                        <div class="table-responsive mb-3">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="text-end mb-4">
                            <h4>Total: ${parseFloat(data.order.total_amount).toFixed(2)} QAR</h4>
                        </div>
                        
                        <div class="text-center">
                            <p class="small">Thank you for your business!</p>
                        </div>
                    </div>
                `;
                
                // Create a hidden iframe for printing
                const printFrame = document.createElement('iframe');
                printFrame.style.position = 'absolute';
                printFrame.style.top = '-1000px';
                printFrame.style.left = '-1000px';
                document.body.appendChild(printFrame);
                
                printFrame.contentDocument.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Invoice - ${data.order_number}</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <style>
                            @media print {
                                body {
                                    font-size: 12px;
                                    padding: 0;
                                    margin: 0;
                                }
                                
                                .invoice-container {
                                    max-width: 80mm;
                                    margin: 0 auto;
                                }
                                
                                .btn, .no-print {
                                    display: none !important;
                                }
                            }
                            
                            body {
                                font-family: Arial, sans-serif;
                            }
                            
                            .invoice-header {
                                text-align: center;
                                border-bottom: 2px solid #000;
                                padding-bottom: 10px;
                                margin-bottom: 15px;
                            }
                            
                            .text-right {
                                text-align: right;
                            }
                            
                            .text-center {
                                text-align: center;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container invoice-container">
                            ${invoiceHtml}
                        </div>
                        <script>
                            // Auto-print when page loads (for POS systems)
                            window.onload = function() {
                                window.print();
                                // After printing, show success message and close
                                setTimeout(function() {
                                    window.close();
                                    // Show success message in parent window
                                    window.parent.postMessage('printSuccess', '*');
                                }, 1000);
                            }
                            
                            // Listen for print success message
                            window.addEventListener('message', function(event) {
                                if (event.data === 'printSuccess') {
                                    alert('Invoice printed successfully!');
                                }
                            });
                        <\/script>
                    </body>
                    </html>
                `);
                printFrame.contentDocument.close();
                
                // Listen for print success message
                window.addEventListener('message', function(event) {
                    if (event.data === 'printSuccess') {
                        // Show success message directly in the POS interface
                        const successAlert = document.createElement('div');
                        successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
                        successAlert.style = 'top: 20px; right: 20px; z-index: 9999;';
                        successAlert.innerHTML = `
                            Invoice printed successfully!
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(successAlert);
                        
                        // Auto-remove after 3 seconds
                        setTimeout(() => {
                            if (successAlert.parentNode) {
                                successAlert.parentNode.removeChild(successAlert);
                            }
                        }, 3000);
                    }
                });
            } else {
                alert('Error loading invoice: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while loading the invoice');
        });
}

// Load recent orders function
function loadRecentOrders() {
    const recentOrdersList = document.getElementById('recentOrdersList');
    recentOrdersList.innerHTML = `
        <div class="text-center">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            Loading recent orders...
        </div>
    `;
    
    fetch('/pos/orders?per_page=5', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.orders && data.orders.length > 0) {
            let html = '<div class="list-group">';
            data.orders.forEach(order => {
                // Format service type badge
                let serviceBadge = { class: 'bg-secondary', text: 'N/A' };
                if (order.service_type) {
                    switch(order.service_type) {
                        case 'on_table':
                            serviceBadge = { class: 'bg-primary', text: 'On Table' };
                            break;
                        case 'take_away':
                            serviceBadge = { class: 'bg-warning', text: 'Take Away' };
                            break;
                        case 'delivery':
                            serviceBadge = { class: 'bg-info', text: 'Delivery' };
                            break;
                        default:
                            serviceBadge = { class: 'bg-secondary', text: order.service_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) };
                    }
                }
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${order.order_number}</h6>
                                <p class="mb-1 text-muted">Table: ${order.table_number}</p>
                                <p class="mb-1"><span class="badge bg-info">${order.regular_items_count || 0} Items</span></p>
                                <small class="text-muted">${order.created_at}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge ${serviceBadge.class} mb-1">${serviceBadge.text}</span>
                                ${order.delivery_company ? `<br><small class="text-muted">${order.delivery_company.charAt(0).toUpperCase() + order.delivery_company.slice(1)}</small>` : ''}
                                <div class="fw-bold">${order.total_amount.toFixed(2)} QAR</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            recentOrdersList.innerHTML = html;
        } else {
            recentOrdersList.innerHTML = '<div class="text-center text-muted">No recent orders found</div>';
        }
    })
    .catch(error => {
        console.error('Error loading recent orders:', error);
        recentOrdersList.innerHTML = '<div class="text-center text-danger">Error loading recent orders</div>';
    });
}

function getStatusBadge(status) {
    switch(status) {
        case 'pending': return { class: 'bg-warning', text: 'Pending' };
        case 'in_progress': return { class: 'bg-info', text: 'In Progress' };
        case 'ready': return { class: 'bg-success', text: 'Ready' };
        case 'served': return { class: 'bg-secondary', text: 'Served' };
        case 'cancelled': return { class: 'bg-danger', text: 'Cancelled' };
        default: return { class: 'bg-secondary', text: status };
    }
}

// Order Completion Modal JavaScript
let selectedServiceType = null;
let selectedDeliveryCompany = null;
let selectedDeliveryCompanyId = null;
let selectedCashierId = null;
let selectedCashierName = null;

// Initialize table selection functionality
function initializeTableSelection() {
    // Table selection in modal
    document.querySelectorAll('.table-btn-modal').forEach(btn => {
        btn.addEventListener('click', function() {
            // Check if table is busy and prevent selection
            const isBusy = this.dataset.isBusy === 'true';
            
            if (isBusy) {
                // Show notification that table is busy
                showNotification(
                    `Table ${this.dataset.tableNumber} is currently busy and cannot be selected. Please choose another table.`,
                    'warning'
                );
                return; // Exit early, don't select the table
            }
            
            // Remove selection from all table buttons
            document.querySelectorAll('.table-btn-modal').forEach(b => b.classList.remove('selected'));
            
            // Add selection to clicked button
            this.classList.add('selected');
            
            // Store selected table info
            window.selectedTableId = parseInt(this.dataset.tableId);
            window.selectedTableNumber = this.dataset.tableNumber;
            
            // Update confirm button state
            updateConfirmButton();
        });
    });
}

// Initialize service type selection with table handling
function initializeServiceTypeSelection() {
    document.querySelectorAll('.service-option').forEach(option => {
        option.addEventListener('click', function() {
            // Check if this option is disabled
            if (this.classList.contains('disabled')) {
                // Show notification about restriction
                const serviceNames = {
                    'take_away': 'Take Away',
                    'delivery': 'Delivery',
                    'card': 'Card Payment'
                };
                const serviceName = serviceNames[this.dataset.service];
                const userRole = '{{ current_user.role.value }}';
                
                showNotification(
                    `${serviceName} service is restricted for ${userRole}s. Please contact your manager for access.`,
                    'warning'
                );
                return; // Exit early, don't select
            }
            
            // Remove selection from all service options
            document.querySelectorAll('.service-option').forEach(opt => opt.classList.remove('selected'));
            
            // Add selection to clicked option
            this.classList.add('selected');
            selectedServiceType = this.dataset.service;
            
            // Update display
            const serviceNames = {
                'take_away': 'Take Away',
                'delivery': 'Delivery'
            };
            document.getElementById('selectedServiceType').textContent = serviceNames[selectedServiceType];
            
            // Hide table selection since on_table service is removed
            const tableSection = document.getElementById('tableSelectionSection');
            tableSection.style.display = 'none';
            // Clear table selection since on_table service is no longer available
            if (!window.isPreSelectedTable) {
                window.selectedTableId = null;
                window.selectedTableNumber = null;
                document.querySelectorAll('.table-option').forEach(opt => opt.classList.remove('selected'));
            }
            
            // Show/hide delivery company section
            if (selectedServiceType === 'delivery') {
                document.getElementById('deliveryCompanySection').style.display = 'block';
                document.getElementById('deliveryCompanyRow').style.display = 'flex';
            } else {
                document.getElementById('deliveryCompanySection').style.display = 'none';
                document.getElementById('deliveryCompanyRow').style.display = 'none';
                selectedDeliveryCompany = null;
                selectedDeliveryCompanyId = null;
                document.getElementById('selectedDeliveryCompany').textContent = 'Not Selected';
            }
            
            // Update confirm button state
            updateConfirmButton();
            document.querySelectorAll('.delivery-option').forEach(opt => opt.classList.remove('selected'));
        });
    });
}

// Initialize cashier selection for waiters
function initializeCashierSelection() {
    document.querySelectorAll('.cashier-option').forEach(option => {
        option.addEventListener('click', function() {
            // Remove selection from all cashier options
            document.querySelectorAll('.cashier-option').forEach(opt => opt.classList.remove('selected'));
            
            // Add selection to clicked option
            this.classList.add('selected');
            selectedCashierId = this.dataset.cashierId;
            selectedCashierName = this.querySelector('.card-title').textContent;
            
            // Update display
            document.getElementById('selectedCashier').textContent = selectedCashierName;
            
            updateConfirmButton();
        });
    });
}

// Delivery company selection
document.querySelectorAll('.delivery-option').forEach(option => {
    option.addEventListener('click', function() {
        // Remove selection from all delivery options
        document.querySelectorAll('.delivery-option').forEach(opt => opt.classList.remove('selected'));
        
        // Add selection to clicked option
        this.classList.add('selected');
        selectedDeliveryCompany = this.dataset.company;
        
        // Update display
        const companyNames = {
            'talabat': 'Talabat',
            'deliveroo': 'Deliveroo',
            'snounou': 'Snounou',
            'rafiq': 'Rafiq'
        };
        document.getElementById('selectedDeliveryCompany').textContent = companyNames[selectedDeliveryCompany];
        
        updateConfirmButton();
    });
});

// Update confirm button state with table validation
function updateConfirmButton() {
    const confirmBtn = document.getElementById('confirmOrderBtn');
    let isValid = false;
    
    if (selectedServiceType) {
        if (selectedServiceType === 'delivery') {
            // For delivery: need delivery company
            isValid = selectedDeliveryCompanyId != null;
        } else {
            // For take_away and card: no additional requirements
            isValid = true;
        }
        
        // For waiters: also need cashier selection
        const userRole = '{{ current_user.role.value }}';
        if (userRole === 'waiter' && isValid) {
            isValid = selectedCashierId != null;
        }
    }
    
    confirmBtn.disabled = !isValid;
}

// Function to print order directly without opening new window
function printOrderDirectly(orderId) {
    fetch(`/pos/get_order_details/${orderId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Create a hidden iframe for printing
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                // Count regular items (excluding special items)
                const regularItemsCount = data.order.items.filter(item => !item.menu_item_name.includes('طلبات خاصة')).length;
                
                // Format service type for prominent display
                let serviceDisplay = 'N/A';
                if (data.order.service_type) {
                    switch(data.order.service_type) {
                        case 'on_table':
                            serviceDisplay = '🍽️ ON TABLE';
                            break;
                        case 'take_away':
                            serviceDisplay = '🥡 TAKE AWAY';
                            break;
                        case 'delivery':
                            serviceDisplay = '🚚 DELIVERY';
                            break;
                        default:
                            serviceDisplay = data.order.service_type.replace('_', ' ').toUpperCase();
                    }
                }
                
                // Create print content
                const printContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Order Receipt</title>
                        <style>
                            @page { size: 80mm auto; margin: 0; }
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 10px; 
                                margin: 0; 
                                padding: 2mm; 
                                width: 76mm; 
                                line-height: 1.2;
                            }
                            .header { 
                                text-align: center; 
                                border-bottom: 1px dashed #000; 
                                padding-bottom: 3px; 
                                margin-bottom: 3px; 
                            }
                            .header h2 { 
                                font-size: 12px; 
                                margin: 0 0 2px 0; 
                                font-weight: bold; 
                            }
                            .header p { 
                                font-size: 9px; 
                                margin: 0; 
                            }
                            .service-highlight { 
                                background: #000; 
                                color: #fff; 
                                padding: 2px; 
                                margin: 3px 0; 
                                text-align: center; 
                                font-weight: bold; 
                                font-size: 10px; 
                            }
                            .delivery-info { 
                                background: #f0f0f0; 
                                padding: 2px; 
                                margin: 2px 0; 
                                text-align: center; 
                                font-weight: bold; 
                                border: 1px solid #000; 
                                font-size: 9px;
                            }
                            .item-count { 
                                background: #e0e0e0; 
                                padding: 2px; 
                                margin: 2px 0; 
                                text-align: center; 
                                font-weight: bold; 
                                border: 1px solid #000; 
                                font-size: 9px;
                            }
                            .order-info { 
                                margin: 3px 0; 
                                font-size: 9px; 
                                line-height: 1.1; 
                            }
                            .order-info div { 
                                margin: 1px 0; 
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin: 3px 0; 
                                font-size: 9px; 
                            }
                            th, td { 
                                border: none; 
                                padding: 1px 2px; 
                                text-align: left; 
                                vertical-align: top;
                            }
                            th { 
                                font-weight: bold; 
                                border-bottom: 1px dashed #000; 
                            }
                            .total-row { 
                                font-weight: bold; 
                                border-top: 1px dashed #000; 
                                font-size: 10px;
                            }
                            .footer { 
                                text-align: center; 
                                margin-top: 5px; 
                                border-top: 1px dashed #000; 
                                padding-top: 3px; 
                                font-size: 8px;
                            }
                            .item-name { 
                                font-weight: bold; 
                            }
                            .item-modifiers { 
                                font-size: 8px; 
                                color: #666; 
                                font-style: italic; 
                            }
                            .dashed-line { 
                                border-top: 1px dashed #000; 
                                margin: 2px 0; 
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h2>🍽️ RESTAURANT POS</h2>
                            <p>Order Receipt</p>
                        </div>
                        
                        <div class="order-info">
                            <div><strong>Order #:</strong> ${data.order.order_number}</div>
                            <div><strong>Date:</strong> ${new Date(data.order.created_at).toLocaleString()}</div>
                            <div><strong>Cashier:</strong> ${data.order.cashier_name || 'N/A'}</div>
                            <div><strong>Table:</strong> ${data.order.table_number || 'N/A'}</div>
                        </div>
                        
                        <div class="service-highlight">
                            ${serviceDisplay}
                        </div>
                        
                        ${data.order.service_type === 'delivery' && data.order.delivery_company ? 
                            `<div class="delivery-info">
                                📱 ${data.order.delivery_company}
                            </div>` : ''}
                        
                        <div class="item-count">
                            📋 ${regularItemsCount} REGULAR ITEMS
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.order.items.map(item => `
                                    <tr>
                                        <td class="item-name">${item.menu_item_name}${item.special_requests ? '<div class="item-modifiers">+ ' + item.special_requests + '</div>' : ''}</td>
                                        <td>${item.quantity}</td>
                                        <td>${parseFloat(item.unit_price).toFixed(2)}</td>
                                        <td>${parseFloat(item.total_price).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                                <tr class="total-row">
                                    <td colspan="3"><strong>TOTAL</strong></td>
                                    <td><strong>${parseFloat(data.order.total_amount).toFixed(2)} QAR</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="footer">
                            <p>Thank you for your business!</p>
                            <p>Printed: ${new Date().toLocaleString()}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                // Write content to iframe and print
                iframe.contentDocument.write(printContent);
                iframe.contentDocument.close();
                
                // Wait for content to load then print
                iframe.onload = function() {
                    iframe.contentWindow.print();
                    // Remove iframe after printing
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                    }, 1000);
                };
                
            } else {
                console.error('Error loading order details for printing:', data.message);
                alert('Error loading order details for printing');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while preparing the receipt for printing');
        });
}

// Confirm order button
document.getElementById('confirmOrderBtn').addEventListener('click', function() {
    if (!selectedServiceType) return;
    
    const orderNotesElement = document.getElementById('orderNotes');
    const orderData = {
        items: window.orderItems,
        table_id: window.selectedTableId,
        notes: orderNotesElement ? orderNotesElement.value : '',
        service_type: selectedServiceType,
        delivery_company_id: selectedDeliveryCompanyId,
        assigned_cashier_id: selectedCashierId,
        return_to: window.returnTo,
        is_adding_items: isAddingToExistingOrder
        {% if existing_order and request.args.get('add_items') == 'true' %}
        , existing_order_id: {{ existing_order.id }}
        {% endif %}
    };
    
    // Debug logging
    console.log('Order confirmation data:', {
        is_adding_items: orderData.is_adding_items,
        existing_order_id: orderData.existing_order_id || 'none',
        items_count: orderData.items.length
    });
    
    fetch('/pos/create_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('orderCompletionModal'));
            modal.hide();
            
            // Clear the order
            window.orderItems = [];
            window.selectedTableId = null;
            selectedServiceType = null;
            selectedDeliveryCompany = null;
            selectedCashierId = null;
            selectedCashierName = null;
            updateOrderDisplay();
            // Clear table selection
            document.querySelectorAll('.table-btn').forEach(btn => btn.classList.remove('selected'));
            window.selectedTableId = null;
            window.selectedTableNumber = null;
            const orderNotesElement2 = document.getElementById('orderNotes');
            if (orderNotesElement2) {
                orderNotesElement2.value = '';
            }
            
            // Automatically print the order invoice directly
            printOrderDirectly(data.order_id || data.id);
            
            // Handle redirection if coming from table management
            if (data.return_to === 'table_management') {
                setTimeout(() => {
                    window.location.href = '/pos/table_management';
                }, 2000); // Wait 2 seconds for printing to complete
            }
        } else {
            // Check if it's a cashier assignment error
            if (data.error_type === 'no_cashier_assignment') {
                alert('⚠️ CASHIER ASSIGNMENT REQUIRED\n\n' + data.message + '\n\nPlease ask your admin to assign you to a cashier before creating orders.');
                // Highlight the cashier assignment section
                const cashierSection = document.getElementById('cashierAssignmentSection');
                if (cashierSection) {
                    cashierSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    cashierSection.classList.add('border', 'border-danger', 'rounded', 'p-2');
                    setTimeout(() => {
                        cashierSection.classList.remove('border', 'border-danger', 'rounded', 'p-2');
                    }, 5000);
                }
            } else {
                alert('Error creating order: ' + data.message);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the order');
    });
});

// ===== POS CALCULATOR FUNCTIONALITY =====
let calculatorMode = 'price'; // 'price' or 'quantity'
let calculatorValue = '0';
let selectedOrderItem = null;
let calculatorActive = false;

// Initialize calculator
document.addEventListener('DOMContentLoaded', function() {
    initializeCalculator();
});

function initializeCalculator() {
    // Mode toggle buttons
    document.getElementById('priceModeBtn').addEventListener('click', function() {
        switchCalculatorMode('price');
    });
    
    document.getElementById('quantityModeBtn').addEventListener('click', function() {
        switchCalculatorMode('quantity');
    });
    
    // Number pad buttons
    document.querySelectorAll('.calc-btn[data-value]').forEach(btn => {
        btn.addEventListener('click', function() {
            appendToCalculator(this.dataset.value);
        });
    });
    
    // Action buttons
    document.querySelector('.calc-btn[data-action="clear"]').addEventListener('click', clearCalculator);
    document.querySelector('.calc-btn[data-action="decimal"]').addEventListener('click', addDecimal);
    document.querySelector('.calc-btn[data-action="reset"]').addEventListener('click', resetCalculator);
    document.querySelector('.calc-btn[data-action="apply"]').addEventListener('click', applyCalculatorValue);
    
    // Quick price buttons
    document.querySelectorAll('.quick-price-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            calculatorValue = this.dataset.price;
            updateCalculatorDisplay();
        });
    });
    
    // Calculator selection is now handled by dedicated calculator buttons
}

function switchCalculatorMode(mode) {
    calculatorMode = mode;
    
    // Update button states
    const priceBtn = document.getElementById('priceModeBtn');
    const quantityBtn = document.getElementById('quantityModeBtn');
    
    if (priceBtn) {
        priceBtn.classList.toggle('active', mode === 'price');
        // Re-enable button if not disabled by item selection
        if (!priceBtn.disabled) {
            priceBtn.classList.remove('disabled');
        }
    }
    
    if (quantityBtn) {
        quantityBtn.classList.toggle('active', mode === 'quantity');
        // Re-enable button if not disabled by item selection
        if (!quantityBtn.disabled) {
            quantityBtn.classList.remove('disabled');
        }
    }
    
    // Update display elements
    const modeDisplay = document.getElementById('calculatorMode');
    const unitDisplay = document.getElementById('calculatorUnit');
    const hintDisplay = document.getElementById('calculatorHint');
    const quickPricesSection = document.getElementById('quickPricesSection');
    const displayIcon = document.getElementById('displayIcon');
    
    if (mode === 'price') {
        modeDisplay.textContent = 'Price Mode';
        modeDisplay.className = 'badge bg-light text-primary';
        unitDisplay.textContent = 'QAR';
        hintDisplay.textContent = 'Select "Special Order" item to set price';
        quickPricesSection.classList.remove('d-none');
        displayIcon.className = 'bi bi-currency-dollar';
    } else {
        modeDisplay.textContent = 'Quantity Mode';
        modeDisplay.className = 'badge bg-light text-success';
        unitDisplay.textContent = 'x';
        hintDisplay.textContent = 'Select any order item to set quantity';
        quickPricesSection.classList.add('d-none');
        displayIcon.className = 'bi bi-x-lg';
    }
    
    resetCalculator();
}

function appendToCalculator(value) {
    if (calculatorValue === '0') {
        calculatorValue = value;
    } else {
        calculatorValue += value;
    }
    updateCalculatorDisplay();
}

function addDecimal() {
    if (calculatorMode === 'quantity') return; // No decimals in quantity mode
    
    if (calculatorValue.indexOf('.') === -1) {
        calculatorValue += '.';
        updateCalculatorDisplay();
    }
}

function clearCalculator() {
    if (calculatorValue.length > 1) {
        calculatorValue = calculatorValue.slice(0, -1);
    } else {
        calculatorValue = '0';
    }
    updateCalculatorDisplay();
}

function resetCalculator() {
    calculatorValue = '0';
    updateCalculatorDisplay();
}

function updateCalculatorDisplay() {
    const display = document.getElementById('calculatorDisplay');
    
    if (calculatorMode === 'quantity') {
        display.value = calculatorValue;
    } else {
        // Format price display
        const numValue = parseFloat(calculatorValue) || 0;
        display.value = numValue.toFixed(2);
    }
}

// Auto-select last added item for calculator
function autoSelectLastItemForCalculator(itemIndex) {
    // Wait for DOM update, then select the item
    setTimeout(() => {
        const orderItemElements = document.querySelectorAll('.order-item-card');
        if (orderItemElements[itemIndex]) {
            selectOrderItemForCalculator(orderItemElements[itemIndex]);
        }
    }, 100);
}

function selectOrderItemForCalculator(orderItemElement) {
    // Remove previous selection
    document.querySelectorAll('.order-item-card').forEach(item => {
        item.classList.remove('calculator-selected');
    });
    
    // Add selection to clicked item
    orderItemElement.classList.add('calculator-selected');
    selectedOrderItem = orderItemElement;
    
    const itemName = orderItemElement.querySelector('.item-name').textContent;
    const itemIndex = parseInt(orderItemElement.getAttribute('data-item-index'));
    const orderItem = window.orderItems[itemIndex];
    
    // Check if this is a special order item
    const isSpecialOrder = itemName.toLowerCase().includes('special order') || 
                          itemName.toLowerCase().includes('طلبات خاصة') || 
                          (orderItem && orderItem.price === 0);
    
    // Update calculator mode based on item type
    if (isSpecialOrder) {
        // Special orders: only price mode allowed
        switchCalculatorMode('price');
        // Disable quantity mode button
        const quantityBtn = document.getElementById('quantityModeBtn');
        if (quantityBtn) {
            quantityBtn.disabled = true;
            quantityBtn.title = 'Quantity mode not available for special orders';
        }
    } else {
        // Regular items: only quantity mode allowed
        switchCalculatorMode('quantity');
        // Disable price mode button
        const priceBtn = document.getElementById('priceModeBtn');
        if (priceBtn) {
            priceBtn.disabled = true;
            priceBtn.title = 'Price mode only available for special orders';
        }
    }
    
    // Update calculator hint
    const hintDisplay = document.getElementById('calculatorHint');
    if (isSpecialOrder) {
        hintDisplay.textContent = `Selected: ${itemName} - Enter price (Special Order)`;
        hintDisplay.className = 'text-warning';
    } else {
        hintDisplay.textContent = `Selected: ${itemName} - Enter quantity (Regular Item)`;
        hintDisplay.className = 'text-success';
    }
}

function applyCalculatorValue() {
    if (!selectedOrderItem) {
        alert('Please select an order item first');
        return;
    }
    
    const value = parseFloat(calculatorValue) || 0;
    if (value <= 0) {
        alert('Please enter a valid value');
        return;
    }
    
    const itemName = selectedOrderItem.querySelector('.fw-bold').textContent;
    
    if (calculatorMode === 'price') {
        // Apply price to special order items
        const priceText = selectedOrderItem.textContent;
        const priceMatch = priceText.match(/(\d+\.?\d*)\s*QAR/);
        const currentPrice = priceMatch ? parseFloat(priceMatch[1]) : 0;
        
        // Check if this is actually a special order item
        const orderItemIndex = parseInt(selectedOrderItem.getAttribute('data-item-index'));
        const orderItem = window.orderItems[orderItemIndex];
        const isSpecialOrder = itemName.toLowerCase().includes('special order') || 
                              itemName.toLowerCase().includes('طلبات خاصة') || 
                              (orderItem && orderItem.price === 0);
        
        if (isSpecialOrder) {
            // Find the order item in the array and update it
            if (window.orderItems && window.orderItems[orderItemIndex]) {
                window.orderItems[orderItemIndex].price = value;
                window.orderItems[orderItemIndex].total = value * window.orderItems[orderItemIndex].quantity;
                
                // Update order display
                updateOrderDisplay();
                
                // Show success feedback
                showCalculatorFeedback(`Price set to ${value.toFixed(2)} QAR for ${itemName}`, 'success');
            }
        } else {
            showCalculatorFeedback('Price mode only works with "Special Order" items', 'error');
            return;
        }
    } else {
        // Apply quantity multiplication (only for regular items, not special orders)
        const orderItemIndex = parseInt(selectedOrderItem.getAttribute('data-item-index'));
        const orderItem = window.orderItems[orderItemIndex];
        const isSpecialOrder = itemName.toLowerCase().includes('special order') || 
                              itemName.toLowerCase().includes('طلبات خاصة') || 
                              (orderItem && orderItem.price === 0);
        
        if (isSpecialOrder) {
            showCalculatorFeedback('Quantity mode not available for Special Order items', 'error');
            return;
        }
        
        if (window.orderItems && window.orderItems[orderItemIndex]) {
            const newQuantity = Math.floor(value);
            window.orderItems[orderItemIndex].quantity = newQuantity;
            window.orderItems[orderItemIndex].total = window.orderItems[orderItemIndex].price * newQuantity;
            
            // Update order display
            updateOrderDisplay();
            
            // Show success feedback
            showCalculatorFeedback(`Quantity set to ${newQuantity} for ${itemName}`, 'success');
        }
    }
    
    // Reset calculator after successful application
    resetCalculator();
    
    // Clear selection
    selectedOrderItem.classList.remove('calculator-selected');
    selectedOrderItem = null;
    
    // Re-enable both calculator mode buttons
    const priceBtn = document.getElementById('priceModeBtn');
    const quantityBtn = document.getElementById('quantityModeBtn');
    if (priceBtn) {
        priceBtn.disabled = false;
        priceBtn.title = 'Price mode for special orders';
    }
    if (quantityBtn) {
        quantityBtn.disabled = false;
        quantityBtn.title = 'Quantity mode for regular items';
    }
    
    // Reset hint
    const hintDisplay = document.getElementById('calculatorHint');
    if (calculatorMode === 'price') {
        hintDisplay.textContent = 'Select "Special Order" item to set price';
    } else {
        hintDisplay.textContent = 'Select any order item to set quantity';
    }
    hintDisplay.className = 'text-muted';
}

function showCalculatorFeedback(message, type) {
    const hintDisplay = document.getElementById('calculatorHint');
    const originalText = hintDisplay.textContent;
    const originalClass = hintDisplay.className;
    
    hintDisplay.textContent = message;
    hintDisplay.className = type === 'success' ? 'text-success fw-bold' : 'text-danger fw-bold';
    
    setTimeout(() => {
        hintDisplay.textContent = originalText;
        hintDisplay.className = originalClass;
    }, 2000);
}

// Calculator styles are now in CSS section

// ==========================================
// COMPREHENSIVE ITEM CUSTOMIZATION SYSTEM
// ==========================================

// Global variables for edit mode
window.isEditMode = false;
window.itemCustomizations = {};
window.draggedElement = null;

// Toggle edit mode
function toggleEditMode() {
    window.isEditMode = !window.isEditMode;
    
    const editBtn = document.getElementById('editModeBtn');
    const editIcon = document.getElementById('editModeIcon');
    const editText = document.getElementById('editModeText');
    const saveBtn = document.getElementById('saveCustomizationsBtn');
    
    if (window.isEditMode) {
        // Enter edit mode
        editBtn.classList.remove('btn-outline-secondary');
        editBtn.classList.add('btn-warning');
        editIcon.className = 'bi bi-unlock';
        editText.textContent = 'Exit Edit';
        saveBtn.classList.remove('d-none');
        
        // Show edit controls on all items
        document.querySelectorAll('.edit-mode-controls').forEach(control => {
            control.classList.remove('d-none');
        });
        
        // Enable drag and drop
        enableDragAndDrop();
        
        // Disable item selection for ordering
        disableItemSelection();
        
        // Load existing customizations
        loadItemCustomizations();
        
        showEditModeNotification('Edit mode enabled. Click items to customize colors and drag to reorder.');
    } else {
        // Exit edit mode
        editBtn.classList.remove('btn-warning');
        editBtn.classList.add('btn-outline-secondary');
        editIcon.className = 'bi bi-lock';
        editText.textContent = 'Edit';
        saveBtn.classList.add('d-none');
        
        // Hide edit controls
        document.querySelectorAll('.edit-mode-controls').forEach(control => {
            control.classList.add('d-none');
        });
        
        // Disable drag and drop
        disableDragAndDrop();
        
        // Re-enable item selection for ordering
        enableItemSelection();
        
        showEditModeNotification('Edit mode disabled. Items can now be added to orders.');
    }
}

// Enable drag and drop functionality
function enableDragAndDrop() {
    document.querySelectorAll('.item-card').forEach(card => {
        card.draggable = true;
        card.style.cursor = 'move';
        
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragend', handleDragEnd);
    });
    
    // Also enable for special items
    document.querySelectorAll('.special-item-customizable').forEach(btn => {
        btn.draggable = true;
        btn.style.cursor = 'move';
        
        btn.addEventListener('dragstart', handleDragStart);
        btn.addEventListener('dragover', handleDragOver);
        btn.addEventListener('drop', handleDrop);
        btn.addEventListener('dragend', handleDragEnd);
    });
}

// Disable drag and drop functionality
function disableDragAndDrop() {
    document.querySelectorAll('.item-card, .special-item-customizable').forEach(element => {
        element.draggable = false;
        element.style.cursor = 'pointer';
        
        element.removeEventListener('dragstart', handleDragStart);
        element.removeEventListener('dragover', handleDragOver);
        element.removeEventListener('drop', handleDrop);
        element.removeEventListener('dragend', handleDragEnd);
    });
}

// Drag and drop event handlers
function handleDragStart(e) {
    window.draggedElement = this;
    this.style.opacity = '0.5';
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    if (window.draggedElement !== this) {
        // Swap positions
        const draggedParent = window.draggedElement.parentNode;
        const targetParent = this.parentNode;
        
        const draggedNext = window.draggedElement.nextSibling;
        const targetNext = this.nextSibling;
        
        if (draggedNext) {
            draggedParent.insertBefore(this, draggedNext);
        } else {
            draggedParent.appendChild(this);
        }
        
        if (targetNext) {
            targetParent.insertBefore(window.draggedElement, targetNext);
        } else {
            targetParent.appendChild(window.draggedElement);
        }
        
        showEditModeNotification('Items reordered. Click Save to apply changes.');
    }
    
    return false;
}

function handleDragEnd(e) {
    this.style.opacity = '1';
    window.draggedElement = null;
}

// Disable item selection during edit mode
function disableItemSelection() {
    document.querySelectorAll('.item-card').forEach(card => {
        card.style.pointerEvents = 'none';
        card.style.opacity = '0.8';
    });
    
    // But enable color picker buttons
    document.querySelectorAll('.color-picker-btn').forEach(btn => {
        btn.style.pointerEvents = 'auto';
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const itemCard = this.closest('.item-card');
            showItemColorPicker(itemCard);
        });
    });
}

// Re-enable item selection after edit mode
function enableItemSelection() {
    document.querySelectorAll('.item-card').forEach(card => {
        card.style.pointerEvents = 'auto';
        card.style.opacity = '1';
    });
}

// Enhanced color picker for individual items
function showItemColorPicker(itemCard) {
    const currentColor = itemCard.dataset.customColor || '';
    const itemName = itemCard.dataset.itemName;
    
    // Enhanced color palette with more options
    const colorPalette = [
        '#ffffff', '#f8f9fa', '#e9ecef', '#dee2e6', '#ced4da',
        '#adb5bd', '#6c757d', '#495057', '#343a40', '#212529',
        '#fff3cd', '#ffeaa7', '#fdcb6e', '#e17055', '#d63031',
        '#74b9ff', '#0984e3', '#00b894', '#00cec9', '#6c5ce7',
        '#a29bfe', '#fd79a8', '#e84393', '#00b894', '#55a3ff',
        '#ff7675', '#fd79a8', '#fdcb6e', '#e17055', '#00cec9'
    ];
    
    // Create enhanced color picker modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Customize "${itemName}"</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Background Color:</label>
                        <div class="color-grid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px;">
                            ${colorPalette.map(color => `
                                <button class="color-option" 
                                        style="width: 32px; height: 32px; background: ${color}; 
                                               border: 2px solid ${currentColor === color ? '#007bff' : '#ccc'}; 
                                               border-radius: 6px; cursor: pointer;" 
                                        data-color="${color}"
                                        title="${color}"></button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Custom Color:</label>
                        <input type="color" class="form-control form-control-color" id="customColorInput" value="${currentColor || '#ffffff'}">
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm flex-fill" id="resetItemColor">Reset to Default</button>
                        <button class="btn btn-primary btn-sm flex-fill" id="applyCustomColor">Apply</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    
    // Color selection handlers
    modal.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            const color = this.dataset.color;
            applyItemColor(itemCard, color);
            bootstrapModal.hide();
        });
    });
    
    // Custom color input handler
    modal.querySelector('#applyCustomColor').addEventListener('click', function() {
        const color = modal.querySelector('#customColorInput').value;
        applyItemColor(itemCard, color);
        bootstrapModal.hide();
    });
    
    // Reset color handler
    modal.querySelector('#resetItemColor').addEventListener('click', function() {
        applyItemColor(itemCard, '');
        bootstrapModal.hide();
    });
    
    // Clean up modal after hiding
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
    
    bootstrapModal.show();
}

// Apply color to individual item (only for non-special items)
function applyItemColor(itemCard, color) {
    // Don't allow color changes for special items
    if (itemCard.classList.contains('special-item-customizable')) {
        return;
    }
    
    const itemId = itemCard.dataset.itemId;
    
    if (color && color !== '#ffffff') {
        // Apply custom color with !important to override CSS
        itemCard.style.setProperty('background', color, 'important');
        itemCard.style.setProperty('border-color', color, 'important');
        itemCard.style.setProperty('border-left', `4px solid ${color}`, 'important');
        itemCard.dataset.customColor = color;
    } else {
        // Reset to default
        itemCard.style.removeProperty('background');
        itemCard.style.removeProperty('border-color');
        itemCard.style.removeProperty('border-left');
        itemCard.dataset.customColor = '';
    }
    
    // Store customization
    if (!window.itemCustomizations[itemId]) {
        window.itemCustomizations[itemId] = {};
    }
    window.itemCustomizations[itemId].color = color || '';
    
    showEditModeNotification(`Color updated for "${itemCard.dataset.itemName}". Click Save to apply changes.`);
}

// Load existing customizations from backend
function loadItemCustomizations() {
    fetch('/pos/get_item_customizations')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.customizations) {
                applyLoadedCustomizations(data.customizations);
            }
        })
        .catch(error => {
            console.error('Error loading customizations:', error);
        });
}

// Apply loaded customizations to items
function applyLoadedCustomizations(customizations) {
    customizations.forEach(customization => {
        const itemId = customization.item_id;
        const itemCard = document.querySelector(`[data-item-id="${itemId}"]`);
        
        // Only apply custom colors to non-special items
        if (itemCard && customization.custom_color && !itemCard.classList.contains('special-item-customizable')) {
            // Apply custom color with !important to override CSS
            itemCard.style.setProperty('background', customization.custom_color, 'important');
            itemCard.style.setProperty('border-color', customization.custom_color, 'important');
            itemCard.style.setProperty('border-left', `4px solid ${customization.custom_color}`, 'important');
            itemCard.dataset.customColor = customization.custom_color;
        }
    });
}

// Save all customizations to backend
function saveItemCustomizations() {
    // Collect current customizations in the format expected by existing API
    const customizations = [];
    
    // Get regular items customizations (exclude special items)
    document.querySelectorAll('.item-card:not(.special-item-customizable)').forEach((card, index) => {
        const itemId = card.dataset.itemId;
        if (itemId) {
            customizations.push({
                item_id: parseInt(itemId),
                custom_color: card.dataset.customColor || '',
                display_order: index
            });
        }
    });
    
    // Special items don't need customization saving - they use fixed alternating colors
    
    // Save to backend using existing API format
    fetch('/pos/save_item_customizations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            customizations: customizations
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showEditModeNotification('Customizations saved successfully!', 'success');
            // Exit edit mode after successful save
            setTimeout(() => {
                toggleEditMode();
            }, 1500);
        } else {
            showEditModeNotification('Error saving customizations: ' + (data.message || data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error saving customizations:', error);
        showEditModeNotification('Error saving customizations. Please try again.', 'error');
    });
}

// Show edit mode notifications
function showEditModeNotification(message, type = 'info') {
    // Remove existing notification
    const existingNotification = document.getElementById('edit-mode-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create new notification
    const notification = document.createElement('div');
    notification.id = 'edit-mode-notification';
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 350px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// General notification function for service restrictions
function showNotification(message, type = 'info') {
    // Remove existing notification
    const existingNotification = document.getElementById('service-restriction-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create new notification
    const notification = document.createElement('div');
    notification.id = 'service-restriction-notification';
    let alertClass = 'alert-info';
    let icon = 'bi-info-circle';
    
    switch(type) {
        case 'success':
            alertClass = 'alert-success';
            icon = 'bi-check-circle';
            break;
        case 'error':
            alertClass = 'alert-danger';
            icon = 'bi-exclamation-triangle';
            break;
        case 'warning':
            alertClass = 'alert-warning';
            icon = 'bi-exclamation-triangle';
            break;
    }
    
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    notification.innerHTML = `
        <i class="bi ${icon} me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Falafel Hab Custom Price Functionality
let falafelHabCurrentPrice = '';

function showFalafelHabPriceModal() {
    // Reset price
    falafelHabCurrentPrice = '';
    document.getElementById('falafelHabPrice').value = '';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('falafelHabPriceModal'));
    modal.show();
}

// Special Order Custom Price Functionality
let specialOrderCurrentPrice = '';

function showSpecialOrderPriceModal() {
    // Reset price
    specialOrderCurrentPrice = '';
    document.getElementById('specialOrderPrice').value = '';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('specialOrderPriceModal'));
    modal.show();
}

function updateFalafelHabPriceDisplay() {
    const priceInput = document.getElementById('falafelHabPrice');
    priceInput.value = falafelHabCurrentPrice;
}

function updateSpecialOrderPriceDisplay() {
    const priceInput = document.getElementById('specialOrderPrice');
    priceInput.value = specialOrderCurrentPrice;
}

function addFalafelHabToOrder() {
    const price = parseFloat(falafelHabCurrentPrice);
    
    if (!price || price <= 0) {
        showNotification('Please enter a valid price for Falafel Hab', 'warning');
        return;
    }
    
    // Add Falafel Hab with custom price to order
    const existingItem = window.orderItems.find(item => 
        item.name === 'Falafel Hab' && item.price === price
    );
    
    if (existingItem) {
        existingItem.quantity += 1;
        existingItem.total = existingItem.quantity * price;
    } else {
        window.orderItems.push({
            id: 'falafel_hab_custom', // Special ID for custom price items
            name: 'Falafel Hab',
            price: price,
            quantity: 1,
            total: price,
            type: 'custom_price',
            modifiers: [],
            isCustomPrice: true
        });
    }
    
    updateOrderDisplay();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('falafelHabPriceModal'));
    modal.hide();
    
    showNotification(`Falafel Hab added with price ${price.toFixed(2)} QAR`, 'success');
}

function addSpecialOrderToOrder() {
    const price = parseFloat(specialOrderCurrentPrice);
    
    if (!price || price <= 0) {
        showNotification('Please enter a valid price for Special Order', 'warning');
        return;
    }
    
    // Add Special Order with custom price to order
    const existingItem = window.orderItems.find(item => 
        item.name === 'special order' && item.price === price
    );
    
    if (existingItem) {
        existingItem.quantity += 1;
        existingItem.total = existingItem.quantity * price;
    } else {
        window.orderItems.push({
            id: 'special_order_custom', // Special ID for custom price items
            name: 'special order',
            price: price,
            quantity: 1,
            total: price,
            type: 'custom_price',
            modifiers: [],
            isCustomPrice: true
        });
    }
    
    updateOrderDisplay();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('specialOrderPriceModal'));
    modal.hide();
    
    showNotification(`Special Order added with price ${price.toFixed(2)} QAR`, 'success');
}

// Initialize Falafel Hab calculator when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Calculator button handlers
    document.querySelectorAll('.calc-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            
            if (value === '.') {
                // Only add decimal point if there isn't one already
                if (!falafelHabCurrentPrice.includes('.')) {
                    falafelHabCurrentPrice += value;
                }
            } else {
                // Limit to reasonable price length
                if (falafelHabCurrentPrice.length < 8) {
                    falafelHabCurrentPrice += value;
                }
            }
            
            updateFalafelHabPriceDisplay();
        });
    });
    
    // Clear button
    document.getElementById('calcClear').addEventListener('click', function() {
        falafelHabCurrentPrice = '';
        updateFalafelHabPriceDisplay();
    });
    
    // Backspace button
    document.getElementById('calcBackspace').addEventListener('click', function() {
        falafelHabCurrentPrice = falafelHabCurrentPrice.slice(0, -1);
        updateFalafelHabPriceDisplay();
    });
    
    // Quick price buttons
    document.querySelectorAll('.quick-price-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            falafelHabCurrentPrice = this.getAttribute('data-price');
            updateFalafelHabPriceDisplay();
        });
    });
    
    // Add button in calculator
    document.getElementById('addFalafelHab').addEventListener('click', function() {
        addFalafelHabToOrder();
    });
    
    // Confirm button in modal footer
    document.getElementById('confirmFalafelHab').addEventListener('click', function() {
        addFalafelHabToOrder();
    });
    
    // Special Order Calculator button handlers
    document.querySelectorAll('.special-calc-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            
            if (value === '.') {
                // Only add decimal point if there isn't one already
                if (!specialOrderCurrentPrice.includes('.')) {
                    specialOrderCurrentPrice += value;
                }
            } else {
                // Limit to reasonable price length
                if (specialOrderCurrentPrice.length < 8) {
                    specialOrderCurrentPrice += value;
                }
            }
            
            updateSpecialOrderPriceDisplay();
        });
    });
    
    // Special Order Clear button
    document.getElementById('specialCalcClear').addEventListener('click', function() {
        specialOrderCurrentPrice = '';
        updateSpecialOrderPriceDisplay();
    });
    
    // Special Order Backspace button
    document.getElementById('specialCalcBackspace').addEventListener('click', function() {
        specialOrderCurrentPrice = specialOrderCurrentPrice.slice(0, -1);
        updateSpecialOrderPriceDisplay();
    });
    
    // Special Order Quick price buttons
    document.querySelectorAll('.special-quick-price-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            specialOrderCurrentPrice = this.getAttribute('data-price');
            updateSpecialOrderPriceDisplay();
        });
    });
    
    // Special Order Add button in calculator
    document.getElementById('addSpecialOrder').addEventListener('click', function() {
        addSpecialOrderToOrder();
    });
    
    // Special Order Confirm button in modal footer
    document.getElementById('confirmSpecialOrder').addEventListener('click', function() {
        addSpecialOrderToOrder();
    });
});

// Admin PIN functionality for waiters
{% if current_user.role.value == 'waiter' %}
document.addEventListener('DOMContentLoaded', function() {
    const enterPinBtn = document.getElementById('enterPinBtn');
    const changeCashierBtn = document.getElementById('changeCashierBtn');
    const backToPinBtn = document.getElementById('backToPinBtn');
    const adminPinModal = new bootstrap.Modal(document.getElementById('adminPinModal'));
    const adminPinInput = document.getElementById('adminPinInput');
    const verifyPinBtn = document.getElementById('verifyPinBtn');
    const pinEntryCard = document.getElementById('pinEntryCard');
    const cashierSelectionCard = document.getElementById('cashierSelectionCard');
    const assignedCashierCard = document.getElementById('assignedCashierCard');
    const assignedCashierName = document.getElementById('assignedCashierName');
    const selectedCashier = document.getElementById('selectedCashier');
    const cashierOptionsContainer = document.getElementById('cashierOptionsContainer');
    
    let currentAdminPin = '';
    let availableCashiers = [];

    // Format PIN input (numbers only)
    adminPinInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 4) value = value.substring(0, 4);
        e.target.value = value;
    });

    // Enter PIN button click - directly show cashier selection
    enterPinBtn.addEventListener('click', function() {
        // Get available cashiers directly
        fetch('/pos/get_cashiers_for_assignment', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                availableCashiers = data.cashiers;
                showCashierSelection();
            } else {
                alert('Error loading cashiers: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error loading cashiers:', error);
            alert('An error occurred while loading cashiers');
        });
    });

    // Change cashier button click
    changeCashierBtn.addEventListener('click', function() {
        // Clear current assignment and show cashier selection directly
        fetch('/pos/clear_assigned_cashier', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Get available cashiers and show selection
                fetch('/pos/get_cashiers_for_assignment', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        availableCashiers = data.cashiers;
                        showCashierSelection();
                    } else {
                        alert('Error loading cashiers: ' + data.message);
                        resetToInitialState();
                    }
                })
                .catch(error => {
                    console.error('Error loading cashiers:', error);
                    alert('An error occurred while loading cashiers');
                    resetToInitialState();
                });
            }
        })
        .catch(error => {
            console.error('Error clearing assignment:', error);
        });
    });

    // Back to PIN button click
    backToPinBtn.addEventListener('click', function() {
        resetToInitialState();
    });

    // Admin PIN verification is no longer needed - cashiers use their own PINs

    // Check if cashier is already assigned on page load
    fetch('/pos/get_assigned_cashier')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Cashier already assigned
                showAssignedCashier(data.cashier);
            }
        })
        .catch(error => {
            console.error('Error checking assigned cashier:', error);
        });

    function showCashierSelection() {
        // Hide other cards and show cashier selection
        pinEntryCard.classList.add('d-none');
        assignedCashierCard.classList.add('d-none');
        cashierSelectionCard.classList.remove('d-none');
        
        // Populate cashier options
        cashierOptionsContainer.innerHTML = '';
        availableCashiers.forEach(cashier => {
            const cashierOption = document.createElement('div');
            cashierOption.className = 'col-md-6 col-12';
            cashierOption.innerHTML = `
                <div class="card cashier-option-card border-2" data-cashier-id="${cashier.id}" style="cursor: pointer;">
                    <div class="card-body text-center p-3">
                        <i class="bi bi-person-circle display-6 text-success mb-2"></i>
                        <h6 class="card-title mb-0">${cashier.name}</h6>
                        <small class="text-muted">${cashier.username}</small>
                    </div>
                </div>
            `;
            
            // Add click handler
            cashierOption.addEventListener('click', function() {
                showCashierPinEntry(cashier);
            });
            
            cashierOptionsContainer.appendChild(cashierOption);
        });
        
        updateConfirmButtonState();
    }

    function showCashierPinEntry(cashier) {
        // Show PIN entry modal for the selected cashier
        const pinModal = document.createElement('div');
        pinModal.className = 'modal fade';
        pinModal.id = 'cashierPinModal';
        pinModal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Enter PIN for ${cashier.name}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <i class="bi bi-person-circle display-4 text-success"></i>
                            <p class="mb-0">Please enter ${cashier.name}'s PIN code</p>
                        </div>
                        <div class="form-group">
                            <label for="cashierPinInput">Cashier PIN</label>
                            <input type="password" class="form-control text-center" id="cashierPinInput" 
                                   maxlength="4" placeholder="Enter 4-digit PIN" autocomplete="off">
                        </div>
                        <div id="cashierPinResult" class="mt-3"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="verifyCashierPinBtn">Verify PIN</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(pinModal);
        const modalInstance = new bootstrap.Modal(pinModal);
        modalInstance.show();
        
        // Focus on PIN input
        setTimeout(() => {
            document.getElementById('cashierPinInput').focus();
        }, 500);
        
        // Handle PIN verification
        document.getElementById('verifyCashierPinBtn').addEventListener('click', function() {
            const pinCode = document.getElementById('cashierPinInput').value.trim();
            if (!pinCode || pinCode.length !== 4) {
                showCashierPinResult('Please enter a 4-digit PIN code', 'error');
                return;
            }
            
            selectCashier(cashier, pinCode);
        });
        
        // Handle Enter key
        document.getElementById('cashierPinInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('verifyCashierPinBtn').click();
            }
        });
        
        // Clean up modal when closed
        pinModal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(pinModal);
        });
    }
    
    function showCashierPinResult(message, type) {
        const resultDiv = document.getElementById('cashierPinResult');
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        resultDiv.innerHTML = `<div class="alert ${alertClass} mb-0">${message}</div>`;
    }

    function selectCashier(cashier, cashierPin) {
        const verifyBtn = document.getElementById('verifyCashierPinBtn');
        const originalText = verifyBtn.innerHTML;
        verifyBtn.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Verifying...';
        verifyBtn.disabled = true;
        
        // Assign cashier to waiter with cashier PIN
        fetch('/pos/assign_cashier_to_waiter', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                cashier_id: cashier.id,
                cashier_pin: cashierPin
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showCashierPinResult('PIN verified successfully!', 'success');
                setTimeout(() => {
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('cashierPinModal'));
                    modalInstance.hide();
                    showAssignedCashier(data.cashier);
                }, 1500);
            } else {
                showCashierPinResult(data.message, 'error');
                verifyBtn.innerHTML = originalText;
                verifyBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error assigning cashier:', error);
            showCashierPinResult('An error occurred while verifying PIN', 'error');
            verifyBtn.innerHTML = originalText;
            verifyBtn.disabled = false;
        });
    }

    function showAssignedCashier(cashier) {
        pinEntryCard.classList.add('d-none');
        cashierSelectionCard.classList.add('d-none');
        assignedCashierCard.classList.remove('d-none');
        assignedCashierName.textContent = cashier.name;
        selectedCashier.textContent = cashier.name;
        
        // Enable confirm button now that cashier is assigned
        const confirmBtn = document.getElementById('confirmOrderBtn');
        if (confirmBtn) {
            confirmBtn.title = 'Send order to ' + cashier.name;
        }
        
        updateConfirmButtonState();
        
        // Auto-refresh the order modal if it's currently open
        const orderModal = document.getElementById('orderCompletionModal');
        if (orderModal && orderModal.classList.contains('show')) {
            // Close and reopen the modal to refresh its content
            const modalInstance = bootstrap.Modal.getInstance(orderModal);
            if (modalInstance) {
                modalInstance.hide();
                // Wait for modal to close, then reopen it
                setTimeout(() => {
                    const completeOrderBtn = document.getElementById('completeOrderBtn');
                    if (completeOrderBtn && !completeOrderBtn.disabled) {
                        completeOrderBtn.click();
                    }
                }, 300);
            }
        }
    }

    function resetToInitialState() {
        pinEntryCard.classList.remove('d-none');
        cashierSelectionCard.classList.add('d-none');
        assignedCashierCard.classList.add('d-none');
        selectedCashier.textContent = 'Not Selected';
        currentAdminPin = '';
        availableCashiers = [];
        
        // Ensure confirm button is disabled when no cashier assigned
        const confirmBtn = document.getElementById('confirmOrderBtn');
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.title = 'Admin must assign a cashier before orders can be sent';
        }
        
        updateConfirmButtonState();
    }

    function showPinResult(message, type) {
        const resultDiv = document.getElementById('pinVerificationResult');
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const iconClass = type === 'success' ? 'bi-check-circle' : 'bi-x-circle';
        
        resultDiv.innerHTML = `
            <div class="alert ${alertClass}">
                <i class="bi ${iconClass} me-2"></i>${message}
            </div>
        `;
    }

    function updateConfirmButtonState() {
        const confirmBtn = document.getElementById('confirmOrderBtn');
        const serviceSelected = document.querySelector('.service-option.selected');
        const cashierAssigned = !assignedCashierCard.classList.contains('d-none');
        
        // Enable confirm button if service is selected and cashier is assigned
        if (serviceSelected && cashierAssigned) {
            confirmBtn.disabled = false;
        } else {
            confirmBtn.disabled = true;
        }
    }

    // Override the original cashier selection logic for waiters
    const originalUpdateConfirmButton = window.updateConfirmButtonState;
    window.updateConfirmButtonState = function() {
        updateConfirmButtonState();
    };
});
{% endif %}

// Note: changeTable() function removed since Change Table button is no longer available for pre-selected tables

</script>
{% endblock %}