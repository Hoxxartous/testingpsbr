{% extends "base.html" %}

{% block title %}Orders - Admin Panel{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>Orders Management</h1>
        
        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="ordersFilterForm" class="row g-3">
                    <div class="col-md-2">
                        <label for="tableFilter" class="form-label">Table</label>
                        <select class="form-select" name="table_id" id="tableFilter">
                            <option value="">All Tables</option>
                            {% for table in tables %}
                            <option value="{{ table.id }}" {% if filters.table_id == table.id|string %}selected{% endif %}>
                                Table {{ table.table_number }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="serviceTypeFilter" class="form-label">Service Type</label>
                        <select class="form-select" name="service_type" id="serviceTypeFilter">
                            <option value="">All Service Types</option>
                            <option value="on_table" {% if filters.service_type == 'on_table' %}selected{% endif %}>On Table</option>
                            <option value="take_away" {% if filters.service_type == 'take_away' %}selected{% endif %}>Take Away</option>
                            <option value="delivery" {% if filters.service_type == 'delivery' %}selected{% endif %}>Delivery</option>
                            <option value="card" {% if filters.service_type == 'card' %}selected{% endif %}>Card Payment</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="paymentStatusFilter" class="form-label">Payment Status</label>
                        <select class="form-select" name="payment_status" id="paymentStatusFilter">
                            <option value="">All Orders</option>
                            <option value="paid" {% if filters.payment_status == 'paid' %}selected{% endif %}>‚úÖ Paid Orders</option>
                            <option value="unpaid" {% if filters.payment_status == 'unpaid' %}selected{% endif %}>‚è≥ Unpaid Orders</option>
                        </select>
                    </div>
                    <div class="col-md-2" id="deliveryCompanyDiv" style="display: none;">
                        <label for="deliveryCompanyFilter" class="form-label">Delivery Company</label>
                        <select class="form-select" name="delivery_company" id="deliveryCompanyFilter">
                            <option value="">All Companies</option>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    {% if current_user.role.name == 'SUPER_USER' %}
                    <div class="col-md-2">
                        <label for="branchFilter" class="form-label">Branch</label>
                        <select class="form-select" id="branchFilter" name="branch_id">
                            <option value="">All Branches</option>
                            {% for branch in branches %}
                            <option value="{{ branch.id }}" {% if filters.branch_id == branch.id %}selected{% endif %}>
                                {{ branch.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div class="col-md-2">
                        <label for="cashierFilter" class="form-label">Cashier</label>
                        <select class="form-select" id="cashierFilter" name="cashier_id">
                            <option value="">All Cashiers</option>
                            {% for cashier in cashiers %}
                            <option value="{{ cashier.id }}" {% if filters.cashier_id == cashier.id|string() %}selected{% endif %}>
                                {{ cashier.get_full_name() }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="dateFrom" class="form-label">From</label>
                        <input type="date" class="form-control" id="dateFrom" name="date_from" 
                               value="{{ filters.date_from }}">
                    </div>
                    <div class="col-md-2">
                        <label for="dateTo" class="form-label">To</label>
                        <input type="date" class="form-control" id="dateTo" name="date_to" 
                               value="{{ filters.date_to }}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <div class="btn-group w-100" role="group">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-funnel"></i> Filter
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clearFilters">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Orders List</h5>
                <div class="badge bg-primary fs-6" id="filteredCount">
                    Total: {{ orders.total }} orders
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Count #</th>
                                <th>Table</th>
                                <th>Items</th>
                                <th>Total (QAR)</th>
                                <th>Payment Status</th>
                                <th>Service</th>
                                <th>Cashier</th>
                                {% if current_user.role.name == 'SUPER_USER' %}
                                <th>Branch</th>
                                <th>Role</th>
                                {% endif %}
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            {% for order in orders.items %}
                            <tr data-order-id="{{ order.id }}">
                                <td>{{ order.order_number }}</td>
                                <td>
                                    {% if order.order_counter %}
                                        <span class="badge bg-dark">{{ order.order_counter }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ order.table.table_number if order.table else 'N/A' }}</td>
                                <td>
                                    {% set regular_items = [] %}
                                    {% for item in order.order_items %}
                                        {% if 'ÿ∑ŸÑÿ®ÿßÿ™ ÿÆÿßÿµÿ©' not in item.menu_item.name %}
                                            {% set _ = regular_items.append(item) %}
                                        {% endif %}
                                    {% endfor %}
                                    <span class="badge bg-info">{{ regular_items | length }}</span>
                                </td>
                                <td>{{ "%.2f"|format(order.total_amount) }}</td>
                                <td>
                                    {% if order.status %}
                                        {% if order.status.value == 'paid' %}
                                            <span class="badge bg-success">‚úÖ Paid</span>
                                        {% elif order.status.value == 'pending' %}
                                            <span class="badge bg-warning">‚è≥ Unpaid</span>
                                        {% elif order.status.value == 'cancelled' %}
                                            <span class="badge bg-danger">‚ùå Cancelled</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ order.status.value.replace('_', ' ').title() }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order.service_type %}
                                        {% if order.service_type.value == 'on_table' %}
                                            <span class="badge bg-primary">On Table</span>
                                        {% elif order.service_type.value == 'take_away' %}
                                            <span class="badge bg-warning">Take Away</span>
                                        {% elif order.service_type.value == 'delivery' %}
                                            <span class="badge bg-info">Delivery</span>
                                            {% if order.delivery_company_info %}
                                                <br><small class="text-muted">{{ order.delivery_company_info.name }}</small>
                                            {% endif %}
                                        {% elif order.service_type.value == 'card' %}
                                            <span class="badge bg-success">Card Payment</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ order.service_type.value.replace('_', ' ').title() }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>{{ order.cashier.username if order.cashier else 'N/A' }}</td>
                                {% if current_user.role.name == 'SUPER_USER' %}
                                <td>
                                    {% if order.branch %}
                                        <span class="badge bg-secondary">{{ order.branch.name }}</span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order.cashier %}
                                        {% if order.cashier.role.value == 'super_user' %}
                                            <span class="badge bg-danger">Super User</span>
                                        {% elif order.cashier.role.value == 'branch_admin' %}
                                            <span class="badge bg-primary">Branch Admin</span>
                                        {% elif order.cashier.role.value == 'cashier' %}
                                            <span class="badge bg-success">Cashier</span>
                                        {% elif order.cashier.role.value == 'waiter' %}
                                            <span class="badge bg-info">Waiter</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ order.cashier.role.value.replace('_', ' ').title() }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                <td>
                                    {{ order.created_at | local_datetime_short }}
                                    {% if order.edit_count and order.edit_count > 0 %}
                                        <br><span class="badge bg-warning text-dark">
                                            <i class="bi bi-pencil-square me-1"></i>Edited {{ order.edit_count }}x
                                        </span>
                                        {% if order.last_edited_at %}
                                            <br><small class="text-muted">Last: {{ order.last_edited_at | local_datetime_short }}</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary view-order" data-order-id="{{ order.id }}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger print-order" data-order-id="{{ order.id }}">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Orders pagination" id="ordersPagination">
                    <ul class="pagination justify-content-center">
                        {% if orders.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="{{ orders.prev_num }}">Previous</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Previous</span>
                        </li>
                        {% endif %}
                        
                        {% for page_num in orders.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != orders.page %}
                                <li class="page-item">
                                    <a class="page-link" href="#" data-page="{{ page_num }}">{{ page_num }}</a>
                                </li>
                                {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">‚Ä¶</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if orders.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="{{ orders.next_num }}">Next</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next</span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
// Set global variable for superuser check
window.isSuperUser = {% if current_user.role.name == 'SUPER_USER' %}true{% else %}false{% endif %};

document.addEventListener('DOMContentLoaded', function() {
    // Helper function to convert string to title case
    function toTitleCase(str) {
        return str.replace(/_/g, ' ').replace(/\w\S*/g, function(txt) {
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
        });
    }
    
    // Handle form submission with AJAX
    document.getElementById('ordersFilterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadOrders(1);
    });
    
    // Clear filters
    document.getElementById('clearFilters').addEventListener('click', function() {
        document.getElementById('ordersFilterForm').reset();
        document.getElementById('deliveryCompanyDiv').style.display = 'none';
        loadOrders(1);
    });
    
    // Show/hide delivery company filter based on service type
    document.getElementById('serviceTypeFilter').addEventListener('change', function() {
        const deliveryDiv = document.getElementById('deliveryCompanyDiv');
        if (this.value === 'delivery') {
            deliveryDiv.style.display = 'block';
        } else {
            deliveryDiv.style.display = 'none';
            document.getElementById('deliveryCompanyFilter').value = '';
        }
    });
    
    // Initialize delivery company visibility on page load
    if (document.getElementById('serviceTypeFilter').value === 'delivery') {
        document.getElementById('deliveryCompanyDiv').style.display = 'block';
    }
    
    // Load delivery companies for filter
    loadDeliveryCompaniesForFilter();
    
    function loadDeliveryCompaniesForFilter() {
        fetch('/admin/get_delivery_companies')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById('deliveryCompanyFilter');
                    const currentValue = '{{ filters.delivery_company }}';
                    
                    // Clear existing options except "All Companies"
                    select.innerHTML = '<option value="">All Companies</option>';
                    
                    // Add delivery company options
                    data.companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.value;
                        option.textContent = company.name;
                        if (company.value === currentValue) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading delivery companies:', error);
            });
    }
    
    // Handle pagination clicks
    document.getElementById('ordersPagination').addEventListener('click', function(e) {
        if (e.target.tagName === 'A' && e.target.dataset.page) {
            e.preventDefault();
            loadOrders(parseInt(e.target.dataset.page));
        }
    });
    
    // Load orders with AJAX
    function loadOrders(page = 1) {
        const formData = new FormData(document.getElementById('ordersFilterForm'));
        const params = new URLSearchParams();
        for (const [key, value] of formData) {
            if (value) {
                params.append(key, value);
            }
        }
        params.append('page', page);
        params.append('per_page', 10);
        
        fetch(`{% if current_user.role.name == 'SUPER_USER' %}{{ url_for('superuser.orders') }}{% else %}{{ url_for('admin.orders') }}{% endif %}?${params.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Update table body
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '';
            
            data.orders.forEach(order => {
                const row = document.createElement('tr');
                row.dataset.orderId = order.id;
                
                // Format service type badge
                let serviceBadge = '<span class="badge bg-secondary">N/A</span>';
                if (order.service_type) {
                    switch(order.service_type) {
                        case 'on_table':
                            serviceBadge = '<span class="badge bg-primary">On Table</span>';
                            break;
                        case 'take_away':
                            serviceBadge = '<span class="badge bg-warning">Take Away</span>';
                            break;
                        case 'delivery':
                            serviceBadge = '<span class="badge bg-info">Delivery</span>';
                            if (order.delivery_company && order.delivery_company.name) {
                                serviceBadge += `<br><small class="text-muted">${order.delivery_company.name}</small>`;
                            }
                            break;
                        case 'card':
                            serviceBadge = '<span class="badge bg-success">Card Payment</span>';
                            break;
                        default:
                            serviceBadge = `<span class="badge bg-secondary">${order.service_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>`;
                    }
                }
                
                // Format role badge
                let roleBadge = '<span class="text-muted">N/A</span>';
                if (order.cashier_role) {
                    switch(order.cashier_role) {
                        case 'super_user':
                            roleBadge = '<span class="badge bg-danger">Super User</span>';
                            break;
                        case 'branch_admin':
                            roleBadge = '<span class="badge bg-primary">Branch Admin</span>';
                            break;
                        case 'cashier':
                            roleBadge = '<span class="badge bg-success">Cashier</span>';
                            break;
                        case 'waiter':
                            roleBadge = '<span class="badge bg-info">Waiter</span>';
                            break;
                        default:
                            roleBadge = `<span class="badge bg-secondary">${order.cashier_role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>`;
                    }
                }
                
                // Check if user is superuser to include branch and role columns
                const isSuperUser = window.isSuperUser;
                
                let branchRoleColumns = '';
                if (isSuperUser) {
                    branchRoleColumns = `
                        <td><span class="badge bg-secondary">${order.branch_name || 'N/A'}</span></td>
                        <td>${roleBadge}</td>
                    `;
                }
                
                // Format counter display
                let counterDisplay = '<span class="text-muted">-</span>';
                if (order.order_counter) {
                    counterDisplay = `<span class="badge bg-dark">${order.order_counter}</span>`;
                }
                
                row.innerHTML = `
                    <td>${order.order_number}</td>
                    <td>${counterDisplay}</td>
                    <td>${order.table_number}</td>
                    <td><span class="badge bg-info">${order.items_count || 0}</span></td>
                    <td>${order.total_amount.toFixed(2)}</td>
                    <td>${serviceBadge}</td>
                    <td>${order.cashier_username}</td>
                    ${branchRoleColumns}
                    <td>${order.created_at.date} ${order.created_at.time}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary view-order" data-order-id="${order.id}">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger print-order" data-order-id="${order.id}">
                                <i class="bi bi-printer"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update pagination
            updatePagination(data.pagination);
            
            // Update filtered count
            document.getElementById('filteredCount').textContent = `Total: ${data.pagination.total} orders`;
            
            // Reattach event listeners for action buttons
            attachActionListeners();
        })
        .catch(error => {
            console.error('Error loading orders:', error);
        });
    }
    
    // Attach event listeners for action buttons
    function attachActionListeners() {
        // View order details
        document.querySelectorAll('.view-order').forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                viewOrderDetails(orderId);
            });
        });
        
        // Print order
        document.querySelectorAll('.print-order').forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                printOrder(orderId);
            });
        });
    }
    
    // View order details function
    function viewOrderDetails(orderId) {
        // Fetch order details and display in a modal
        fetch(`/admin/get_order_details/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create items HTML with edit tracking
                    let itemsHtml = '';
                    data.items.forEach(item => {
                        // Build modifiers display
                        let modifiersHtml = '';
                        if (item.modifiers && Array.isArray(item.modifiers) && item.modifiers.length > 0) {
                            modifiersHtml = '<br><small class="text-muted">Modifiers: ' + 
                                item.modifiers.map(mod => mod.name).join(', ') + '</small>';
                        } else if (item.modifiers && typeof item.modifiers === 'string' && item.modifiers.trim()) {
                            // Handle case where modifiers is stored as a string
                            modifiersHtml = '<br><small class="text-muted">Modifiers: ' + item.modifiers + '</small>';
                        }
                        
                        // Add special requests display
                        let specialRequestsHtml = '';
                        if (item.special_requests) {
                            specialRequestsHtml = `<br><small class="text-primary"><i class="bi bi-stars"></i> ${item.special_requests}</small>`;
                        }
                        
                        // Style for deleted/new items
                        const isDeleted = item.is_deleted || false;
                        const isNew = item.is_new || false;
                        let rowStyle = '';
                        let itemPrefix = '';
                        
                        if (isDeleted) {
                            rowStyle = 'style="text-decoration: line-through; background-color: #ffebee; color: #666;"';
                            itemPrefix = 'üö´ ';
                        } else if (isNew) {
                            rowStyle = 'style="background-color: #e8f5e8; font-weight: bold;"';
                            itemPrefix = 'üÜï ';
                        }
                        
                        itemsHtml += `
                            <tr ${rowStyle}>
                                <td>${itemPrefix}${item.menu_item_name}${modifiersHtml}${specialRequestsHtml}</td>
                                <td>${item.quantity}</td>
                                <td>${parseFloat(item.unit_price).toFixed(2)} QAR</td>
                                <td>${parseFloat(item.total_price).toFixed(2)} QAR</td>
                            </tr>
                        `;
                    });
                    
                    // Edit history section
                    let editHistoryHtml = '';
                    if (data.edit_count && data.edit_count > 0) {
                        editHistoryHtml = `
                            <div class="alert alert-warning mt-3">
                                <h6><i class="bi bi-pencil-square"></i> Edit History</h6>
                                <p><strong>Edited ${data.edit_count} time(s)</strong></p>
                                ${data.last_edited_at ? `<p><small>Last edited: ${new Date(data.last_edited_at).toLocaleString()}</small></p>` : ''}
                                ${data.last_edited_by ? `<p><small>Last edited by: ${data.last_edited_by}</small></p>` : ''}
                            </div>
                        `;
                    }
                    
                    const modalHtml = `
                        <div class="modal fade" id="orderDetailsModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Order Details - ${data.order_number}${data.order_counter ? ` (Count #${data.order_counter})` : ''}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <p><strong>Cashier:</strong> ${data.cashier_name || 'N/A'}</p>
                                                <p><strong>Table:</strong> ${data.table_number || 'N/A'}</p>
                                            </div>
                                            <div class="col-md-6 text-end">
                                                <p><strong>Order #:</strong> ${data.order_number}</p>
                                                ${data.order_counter ? `<p><strong>Count #:</strong> <span class="badge bg-dark">${data.order_counter}</span></p>` : ''}
                                                <p><strong>Date:</strong> ${new Date(data.created_at).toLocaleString()}</p>
                                                <p><strong>Service:</strong> ${data.service_type ? data.service_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'}</p>
                                                ${data.delivery_company ? `<p><strong>Delivery:</strong> ${data.delivery_company}</p>` : ''}
                                                <p><strong>Total:</strong> ${parseFloat(data.total_amount).toFixed(2)} QAR</p>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Item</th>
                                                        <th>Qty</th>
                                                        <th>Price</th>
                                                        <th>Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${itemsHtml}
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        ${editHistoryHtml}
                                        
                                        <div class="text-end">
                                            <h4>Total: ${parseFloat(data.total_amount).toFixed(2)} QAR</h4>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-primary print-order-modal" data-order-id="${data.id}">
                                            <i class="bi bi-printer"></i> Print Invoice
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Remove existing modal if any
                    const existingModal = document.getElementById('orderDetailsModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Add modal to body
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                    modal.show();
                    
                    // Add event listener for print button in modal
                    document.querySelector('.print-order-modal').addEventListener('click', function() {
                        printOrder(data.id);
                    });
                } else {
                    showNotification('Error loading order details: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while loading the order details', 'error');
            });
    }
    
    // Print order function - Kitchen Printer Compatible (same as POS orders)
    function printOrder(orderId) {
        // Fetch order details and print
        fetch(`/admin/get_order_details/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Count regular items (excluding special items)
                    const regularItemsCount = data.items.filter(item => !item.name.includes('ÿ∑ŸÑÿ®ÿßÿ™ ÿÆÿßÿµÿ©')).length;
                    
                    // Format service type for prominent display
                    let serviceDisplay = 'N/A';
                    if (data.service_type) {
                        switch(data.service_type) {
                            case 'on_table':
                                serviceDisplay = 'üçΩÔ∏è ON TABLE';
                                break;
                            case 'take_away':
                                serviceDisplay = 'üì¶ TAKE AWAY';
                                break;
                            case 'delivery':
                                serviceDisplay = 'üöö DELIVERY';
                                break;
                            case 'card':
                                serviceDisplay = 'üí≥ CARD PAYMENT';
                                break;
                            default:
                                serviceDisplay = data.service_type.replace('_', ' ').toUpperCase();
                        }
                    }
                    
                    // Create invoice HTML with kitchen printer format
                    let itemsHtml = '';
                    data.items.forEach(item => {
                        let modifiersHtml = '';
                        if (item.modifiers && item.modifiers.trim()) {
                            modifiersHtml = `<br><small>${item.modifiers}</small>`;
                        }
                        
                        itemsHtml += `
                            <tr>
                                <td style="border-bottom: 1px solid #000; padding: 3px 2px;">
                                    ${item.name}${modifiersHtml}
                                </td>
                                <td style="border-bottom: 1px solid #000; padding: 3px 2px;">${item.quantity}</td>
                                <td style="border-bottom: 1px solid #000; padding: 3px 2px; text-align: right;">${parseFloat(item.unit_price).toFixed(2)} QAR</td>
                                <td style="border-bottom: 1px solid #000; padding: 3px 2px; text-align: right;">${parseFloat(item.total_price).toFixed(2)} QAR</td>
                            </tr>
                        `;
                    });
                    
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Invoice - ${data.order_number}</title>
                            <style>
                                @page { size: 80mm auto; margin: 0; }
                                body { 
                                    font-family: 'Courier New', monospace; 
                                    font-size: 10px; 
                                    margin: 0; 
                                    padding: 2mm; 
                                    width: 76mm; 
                                    line-height: 1.2;
                                }
                                .header { 
                                    text-align: center; 
                                    border-bottom: 1px dashed #000; 
                                    padding-bottom: 3px; 
                                    margin-bottom: 3px; 
                                }
                                .header h3 { 
                                    font-size: 12px; 
                                    margin: 0 0 2px 0; 
                                    font-weight: bold; 
                                }
                                .header p { 
                                    font-size: 9px; 
                                    margin: 0; 
                                }
                                .service-highlight { 
                                    background: #000; 
                                    color: #fff; 
                                    padding: 2px; 
                                    margin: 3px 0; 
                                    text-align: center; 
                                    font-weight: bold; 
                                    font-size: 10px; 
                                }
                                .delivery-info { 
                                    background: #f0f0f0; 
                                    padding: 2px; 
                                    margin: 2px 0; 
                                    text-align: center; 
                                    font-weight: bold; 
                                    border: 1px solid #000; 
                                    font-size: 9px;
                                }
                                .item-count { 
                                    background: #e0e0e0; 
                                    padding: 2px; 
                                    margin: 2px 0; 
                                    text-align: center; 
                                    font-weight: bold; 
                                    border: 1px solid #000; 
                                    font-size: 9px;
                                }
                                table { 
                                    width: 100%; 
                                    border-collapse: collapse; 
                                    margin: 3px 0; 
                                    font-size: 9px; 
                                }
                                th, td { 
                                    border: none; 
                                    padding: 1px 2px; 
                                    text-align: left; 
                                    vertical-align: top;
                                }
                                th { 
                                    font-weight: bold; 
                                    border-bottom: 1px dashed #000; 
                                }
                                .total-row { 
                                    font-weight: bold; 
                                    border-top: 1px dashed #000; 
                                    font-size: 10px;
                                }
                                .footer { 
                                    text-align: center; 
                                    margin-top: 5px; 
                                    border-top: 1px dashed #000; 
                                    padding-top: 3px; 
                                    font-size: 8px;
                                }
                                .item-name { 
                                    font-weight: bold; 
                                }
                                .item-modifiers { 
                                    font-size: 8px; 
                                    color: #666; 
                                    font-style: italic; 
                                }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h3>üçΩÔ∏è RESTAURANT POS</h3>
                                <p><strong>Order #${data.order_number}</strong>${data.order_counter ? ` | Count #${data.order_counter}` : ''}</p>
                                <p>${new Date(data.created_at).toLocaleString()}</p>
                                ${data.table_number ? `<p><strong>Table: ${data.table_number}</strong></p>` : ''}
                                ${data.cashier_name ? `<p><strong>Cashier:</strong> ${data.cashier_name}</p>` : ''}
                            </div>
                                
                                <!-- Prominent Service Type Display -->
                                <div class="service-highlight">
                                    ${serviceDisplay}
                                </div>
                                
                                <!-- Delivery Company Info -->
                                ${data.service_type === 'delivery' && data.delivery_company ? 
                                    `<div class="delivery-info">
                                        üì± ${data.delivery_company}
                                    </div>` : ''}
                                
                                <!-- Item Count -->
                                <div class="item-count">
                                    üìã ${regularItemsCount} REGULAR ITEMS
                                </div>
                                
                                <div style="margin-top: 10px;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Item</th>
                                                <th>Qty</th>
                                                <th style="text-align: right;">Price</th>
                                                <th style="text-align: right;">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${itemsHtml}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div style="margin-top: 10px;">
                                    <table style="width: 100%; margin-top: 10px;">
                                        <tr>
                                            <td style="font-weight: bold;">Total:</td>
                                            <td style="text-align: right; font-weight: bold;">${parseFloat(data.total_amount).toFixed(2)} QAR</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div style="text-align: center; margin-top: 15px;">
                                    <p><strong>Thank you for your business!</strong></p>
                                    <p>Visit us again soon.</p>
                                </div>
                            </div>
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                    printWindow.print();
                    printWindow.close();
                } else {
                    alert('Error loading order details: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while loading the order details');
            });
    }
    
    // Call attachActionListeners initially to attach to existing buttons
    attachActionListeners();
    
    // Update pagination controls
    function updatePagination(pagination) {
        const paginationElement = document.getElementById('ordersPagination');
        let paginationHtml = '<ul class="pagination justify-content-center">';
        
        // Previous button
        if (pagination.has_prev) {
            paginationHtml += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.prev_num}">Previous</a>
                </li>
            `;
        } else {
            paginationHtml += `
                <li class="page-item disabled">
                    <span class="page-link">Previous</span>
                </li>
            `;
        }
        
        // Page numbers
        // Simplified pagination for demo - in a real app you'd want more sophisticated pagination
        for (let i = 1; i <= Math.min(5, pagination.pages); i++) {
            if (i === pagination.page) {
                paginationHtml += `
                    <li class="page-item active">
                        <span class="page-link">${i}</span>
                    </li>
                `;
            } else {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
        }
        
        // Next button
        if (pagination.has_next) {
            paginationHtml += `
                <li class="page-item">
                    <a class="page-link" href="#" data-page="${pagination.next_num}">Next</a>
                </li>
            `;
        } else {
            paginationHtml += `
                <li class="page-item disabled">
                    <span class="page-link">Next</span>
                </li>
            `;
        }
        
        paginationHtml += '</ul>';
        paginationElement.innerHTML = paginationHtml;
        
        // Reattach event listeners
        paginationElement.addEventListener('click', function(e) {
            if (e.target.tagName === 'A' && e.target.dataset.page) {
                e.preventDefault();
                loadOrders(parseInt(e.target.dataset.page));
            }
        });
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style = 'top: 20px; right: 20px; z-index: 9999;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }
});
</script>
{% endblock %}